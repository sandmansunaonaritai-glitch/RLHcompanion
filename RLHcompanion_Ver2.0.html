<!--RLHcompanion_Ver1.2-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLH Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
   
   <style>/* â‘ ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        
        /* D66 Grid Styles */
        .d66-grid-container { width: 100%; display: grid; grid-template-columns: repeat(6, 1fr); border: 1px solid #14b8a6; max-width: 180px; }
        .d66-grid-cell { aspect-ratio: 1.1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; border: 1px solid #e5e7eb; position: relative; background: #fff; }
        
        /* å›æ•°ã”ã¨ã®èƒŒæ™¯è‰² */
        .cell-row-0 { background-color: #ccfbf1 !important; border-color: #2dd4bf; } /* 1å›ç›®ï¼šã‚¿ãƒ¼ã‚³ã‚¤ã‚º */
        .cell-row-1 { background-color: #fef3c7 !important; border-color: #fbbf24; } /* 2å›ç›®ï¼šã‚¢ãƒ³ãƒãƒ¼ */
        .cell-row-2 { background-color: #ffe4e6 !important; border-color: #fb7185; } /* 3å›ç›®ï¼šãƒ­ãƒ¼ã‚º */
        .d66-order-tag { position: absolute; font-size: 0.5rem; color: #374151; font-weight: 900; }

        /* Drag & Drop Indicators */
        .drop-top { border-top: 3px solid #6366f1 !important; }
        .drop-bottom { border-bottom: 3px solid #6366f1 !important; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        /* Record Table */
        .record-table { border-collapse: collapse; font-size: 10px; width: 100%; min-width: 600px; table-layout: fixed; }
        .record-table th, .record-table td { border: 1px solid #ccc; text-align: center; padding: 2px 0; height: 22px; }
        .record-table th { background: #f9fafb; color: #667085; }
        .record-table tr.active-row { background: #fffbeb; outline: 2px solid #f59e0b; outline-offset: -2px; }
        .resource-input { padding: 0.1rem; font-size: 0.85rem; text-align: center; border-radius: 0.25rem; width: 2.8rem; border: 1px solid #d1d5db; }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³è‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .choice-btn {
         flex: 1 1 calc(33% - 8px);
         min-width: 80px; /* ã‚ã¾ã‚Šã«ç‹­ããªã‚Šã™ããªã„ã‚ˆã†ã« */
         background:  #ebe7ff;
         border: 1px solid #d1d5db; /* ç·šã®è‰²ã‚’ã‚°ãƒ¬ãƒ¼ã«ã—ã¦ç´°ã */
         color: #374151;
         font-weight: normal; /* å¤ªå­—ã‚’ã‚„ã‚ã‚‹ */
         padding: 6px;
         border-radius: 4px;
         font-size: 12px;
         }

        .choice-btn:hover {background: #eef2ff;transform: translateY(-1px);}
        .choice-btn:active {transform: translateY(1px);}

        /* Mobile Tab View */
        @media (max-width: 1023px) {
        /* 1. ç”»é¢å…¨ä½“ã®å›ºå®šï¼ˆäºŒé‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ï¼‰ */
        body {
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* å¤–å´ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
        }

        /* 2. ã‚¿ãƒ–ã‚¨ãƒªã‚¢ã®åŸºæœ¬è¨­å®š */
        .view-tab { display: none !important; }
        .view-tab.active { 
        display: flex !important; 
        flex-direction: column; 
        width: 100% !important; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’å¼•ã„ãŸæ®‹ã‚Šã‚’è¨­å®š */
        height: calc(100dvh - 140px) !important; 
        height: 100% !important; 
        overflow-y: auto !important; /* åŸºæœ¬ã¯ã“ã“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
        -webkit-overflow-scrolling: touch;
        }

        /* 3. ãƒ­ã‚°ã‚¿ãƒ–å°‚ç”¨ã®è¨­å®šï¼ˆå…¥åŠ›æ¬„ã‚’ä¸‹ã«å›ºå®šã€ãƒ­ã‚°ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
        #log-section.active {
        overflow: hidden !important; /* ãƒ­ã‚°ã‚¿ãƒ–è‡ªä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãšã€ä¸­èº«ã§åˆ¶å¾¡ */
        }

            /* ãƒ­ã‚°ãƒªã‚¹ãƒˆï¼šå¯å¤‰ã‚¨ãƒªã‚¢ */
             #log-list { 
            flex: 1 !important; 
            overflow-y: auto !important; 
            min-height: 0; 
            padding-bottom: 10px;
            }

            /* ãƒ­ã‚°å…¥åŠ›ã‚¨ãƒªã‚¢ï¼šIDã§ç›´æ¥æŒ‡å®š */
            #input-control-panel { /* å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’åŒ…ã‚€divã«ã“ã®IDã‚’ä»˜ã‘ã‚‹ */
            flex-shrink: 0 !important;
            background: #f9fafb;
            padding: 8px;
            border-top: 1px solid #e5e7eb;
            }

            /* é¸æŠè‚¢ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            #choice-container {
            flex-shrink: 0 !important;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px;
            background-color: transparent; /* èƒŒæ™¯ã‚’é€æ˜ã« */
            border: none; /* ç·šã‚’å®Œå…¨ã«æ¶ˆã™ */
            }

            #choice-container.hidden {display: none !important;}

        /* 4. ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ç¸®å°åŒ–ï¼ˆPixel 8aå¯¾å¿œï¼‰ */
        header .flex-nowrap {gap: 2px !important;}
        header button {
        padding: 4px 6px !important;
        font-size: 10px !important;
        white-space: nowrap;
        }

            /* ã‚»ãƒƒã‚·ãƒ§ãƒ³åå…¥åŠ›æ¬„ã®å¹…ã‚’ç¢ºä¿ */
            #logTitle {min-width: 60px !important;}

            /* ãƒ¢ãƒã‚¤ãƒ«ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³è‰² */
            .tab-btn.active {
            background-color: #4f46e5 !important; /* é®®ã‚„ã‹ãªã‚¤ãƒ³ãƒ‡ã‚£ã‚´ */
            color: white !important;
            border-bottom: 3px solid #facc15 !important; /* ä¸‹ç·šã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®é»„è‰² */
            font-weight: bold;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ï¼šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ï¼ˆåŸºæœ¬çŠ¶æ…‹ï¼‰ */
            .tab-btn {
                background-color: #374151 !important; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
                color: #d1d5db !important;
                transition: all 0.2s;
            }
        }
       /* ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
       .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
       .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; }

       /* Toast Notification */
       #toast-container {
           position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
           z-index: 9999; width: 90%; max-width: 350px; pointer-events: none;
           display: flex; flex-direction: column; gap: 8px;
       }
       .toast-msg {
           background: rgba(17, 24, 39, 0.95); color: #fff; padding: 12px;
           border-radius: 6px; font-size: 12px; line-height: 1.4;
           box-shadow: 0 4px 6px rgba(0,0,0,0.2);
           opacity: 0; transform: translateY(10px); transition: all 0.3s ease;
           pointer-events: auto; text-align: center; white-space: pre-wrap;
           border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
       }
       .toast-msg.show { opacity: 1; transform: translateY(0); }

       /* --- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆç”¨CSS --- */
       /* ======================================= */
       /*           Night Mode (Slate)            */
       /* ======================================= */
       body.theme-night { background-color: #0f172a !important; color: #cbd5e1 !important; }
       
       /* --- Containers & Backgrounds --- */
       body.theme-night .bg-white, body.theme-night .bg-gray-50, body.theme-night .bg-gray-100, body.theme-night .bg-gray-200,
       body.theme-night details, body.theme-night summary,
       body.theme-night [class*="bg-red-50"], body.theme-night [class*="bg-blue-50"], body.theme-night [class*="bg-green-50"],
       body.theme-night [class*="bg-yellow-50"], body.theme-night [class*="bg-orange-50"], body.theme-night [class*="bg-indigo-50"],
       body.theme-night [class*="bg-amber-50"], body.theme-night [class*="bg-purple-50"], body.theme-night [class*="bg-teal-50"],
       body.theme-night [class*="bg-emerald-50"], body.theme-night [class*="bg-slate-50"], body.theme-night [class*="bg-rose-50"] {
           background-color: #1e293b !important; border-color: #334155 !important; color: #e2e8f0 !important;
       }
       body.theme-night summary:hover { background-color: #28364a !important; }

       /* --- Header --- */
       body.theme-night header, body.theme-night header .bg-gray-800, body.theme-night header .bg-gray-900, body.theme-night header .bg-gray-700 {
           background-color: #020617 !important; border-color: #1e293b !important;
       }
       body.theme-night header input { color: #fff !important; background-color: #1e293b !important; }

       /* --- Inputs & Text --- */
       body.theme-night input, body.theme-night textarea, body.theme-night select { 
           background-color: #0f172a !important; color: #f1f5f9 !important; border-color: #475569 !important; 
       }
       body.theme-night [class*="text-"] { color: #cbd5e1 !important; }
       body.theme-night .text-white { color: #ffffff !important; }
       body.theme-night .text-gray-400 { color: #94a3b8 !important; }

       /* --- Buttons by Role (Night Mode) --- */
       /* 1. è£œåŠ©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Slate) */
       body.theme-night button, body.theme-night .bg-slate-600,
       /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ±ç”¨ãƒ€ã‚¤ã‚¹ */
       body.theme-night header .bg-gray-600, body.theme-night header .bg-yellow-600, body.theme-night header .bg-orange-600, body.theme-night header .bg-blue-600, body.theme-night header .bg-green-600, body.theme-night header .bg-purple-600,
       /* ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã®ã€ŒæŠ€ã€ãƒœã‚¿ãƒ³ã¨ã€ŒRollã€ãƒœã‚¿ãƒ³ */
       body.theme-night #view-char .bg-gray-500, body.theme-night #view-char .bg-orange-500, body.theme-night #view-char .bg-emerald-500, body.theme-night #view-char .bg-purple-500, body.theme-night #view-char .bg-red-600 {
           background-color: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important;
       }
       body.theme-night button:hover, body.theme-night .bg-slate-600:hover,
       body.theme-night header .bg-gray-600:hover, body.theme-night header .bg-yellow-600:hover, body.theme-night header .bg-orange-600:hover, body.theme-night header .bg-blue-600:hover, body.theme-night header .bg-green-600:hover, body.theme-night header .bg-purple-600:hover,
       body.theme-night #view-char .bg-gray-500:hover, body.theme-night #view-char .bg-orange-500:hover, body.theme-night #view-char .bg-emerald-500:hover, body.theme-night #view-char .bg-purple-500:hover, body.theme-night #view-char .bg-red-600:hover { background-color: #475569 !important; }

       /* 2. ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Blue) */
       body.theme-night .bg-blue-700, body.theme-night .bg-green-700, body.theme-night .bg-teal-600,
       /* ã‚·ãƒŠãƒªã‚ªé€²è¡Œãƒœã‚¿ãƒ³ */
       body.theme-night #log-section .bg-indigo-600, body.theme-night #log-section .bg-slate-700, body.theme-night #log-section .bg-orange-600, body.theme-night #log-section .bg-gray-500, body.theme-night #log-section .bg-blue-500, body.theme-night #log-section .bg-amber-500, body.theme-night #log-section .bg-rose-500, body.theme-night #log-section .bg-emerald-500,
       /* ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã®ã€Œèƒ½ã€ãƒœã‚¿ãƒ³ */
       body.theme-night #view-char .bg-orange-600, body.theme-night #view-char .bg-emerald-600, body.theme-night #view-char .bg-gray-600, body.theme-night #view-char .bg-purple-600, body.theme-night #view-char .bg-blue-600 {
           background-color: #1d4ed8 !important; color: #eff6ff !important; border-color: #1e40af !important;
       }
       body.theme-night .bg-blue-700:hover, body.theme-night .bg-green-700:hover, body.theme-night .bg-teal-600:hover,
       body.theme-night #log-section .bg-indigo-600:hover, body.theme-night #log-section .bg-slate-700:hover, body.theme-night #log-section .bg-orange-600:hover, body.theme-night #log-section .bg-gray-500:hover, body.theme-night #log-section .bg-blue-500:hover, body.theme-night #log-section .bg-amber-500:hover, body.theme-night #log-section .bg-rose-500:hover, body.theme-night #log-section .bg-emerald-500:hover,
       body.theme-night #view-char .bg-orange-600:hover, body.theme-night #view-char .bg-emerald-600:hover, body.theme-night #view-char .bg-gray-600:hover, body.theme-night #view-char .bg-purple-600:hover, body.theme-night #view-char .bg-blue-600:hover { background-color: #1e40af !important; }

       /* 3. å±é™ºãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Red) */
       body.theme-night .bg-red-700 {
           background-color: #991b1b !important; color: #fecaca !important; border-color: #7f1d1d !important;
       }
       body.theme-night .bg-red-700:hover { background-color: #7f1d1d !important; }

       /* --- Specific Components --- */
       body.theme-night details > summary.bg-teal-100 { background-color: #0f172a !important; border-bottom: 1px solid #334155 !important; }
       body.theme-night .d66-grid-cell { background-color: #1e293b !important; border-color: #334155 !important; color: #e2e8f0 !important; }
       body.theme-night .cell-row-0 { background-color: #134e4a !important; color: #ccfbf1 !important; border-color: #115e59 !important; }
       body.theme-night .cell-row-1 { background-color: #78350f !important; color: #fef3c7 !important; border-color: #92400e !important; }
       body.theme-night .cell-row-2 { background-color: #881337 !important; color: #ffe4e6 !important; border-color: #9f1239 !important; }
       body.theme-night .record-table tr.active-row { background-color: #312e81 !important; }
       body.theme-night .choice-btn { background-color: #312e81 !important; color: #e0e7ff !important; border-color: #4338ca !important; }
       body.theme-night #view-char div.border-blue-300.bg-blue-50 { background-color: #312e81 !important; border-color: #4f46e5 !important; }
       body.theme-night #view-char div.border-blue-300.bg-blue-50 span { color: #e0e7ff !important; }

       /* ======================================= */
       /*           Sepia Mode (Parchment)        */
       /* ======================================= */
       body.theme-sepia { background-color: #f5e5c5 !important; color: #4e342e !important; }

       /* --- Containers & Backgrounds --- */
       body.theme-sepia .bg-white, body.theme-sepia .bg-gray-50, body.theme-sepia .bg-gray-100, body.theme-sepia .bg-gray-200,
       body.theme-sepia details, body.theme-sepia summary,
       body.theme-sepia [class*="bg-red-50"], body.theme-sepia [class*="bg-blue-50"], body.theme-sepia [class*="bg-green-50"],
       body.theme-sepia [class*="bg-yellow-50"], body.theme-sepia [class*="bg-orange-50"], body.theme-sepia [class*="bg-indigo-50"],
       body.theme-sepia [class*="bg-amber-50"], body.theme-sepia [class*="bg-purple-50"], body.theme-sepia [class*="bg-teal-50"],
       body.theme-sepia [class*="bg-emerald-50"], body.theme-sepia [class*="bg-slate-50"], body.theme-sepia [class*="bg-rose-50"] {
           background-color: #fdf6e3 !important; border-color: #d3c6a6 !important; color: #5d4037 !important;
       }
       body.theme-sepia summary:hover { background-color: #faf3e0 !important; }

       /* --- Header --- */
       body.theme-sepia header, body.theme-sepia header .bg-gray-800, body.theme-sepia header .bg-gray-900, body.theme-sepia header .bg-gray-700 {
           background-color: #4e342e !important; border-color: #6d4c41 !important;
       }
       body.theme-sepia header input { color: #fff !important; background-color: #6d4c41 !important; }

       /* --- Inputs & Text --- */
       body.theme-sepia input, body.theme-sepia textarea, body.theme-sepia select {
           background-color: #fffbf0 !important; color: #3e2723 !important; border-color: #d3c6a6 !important;
       }
       body.theme-sepia [class*="text-"] { color: #4e342e !important; }
       body.theme-sepia .text-white { color: #fff !important; }
       body.theme-sepia .text-gray-400 { color: #a1887f !important; }

       /* --- Buttons by Role (Sepia Mode) --- */
       /* 1. è£œåŠ©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Brown-Gray) */
       body.theme-sepia button, body.theme-sepia .bg-slate-600,
       /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ±ç”¨ãƒ€ã‚¤ã‚¹ */
       body.theme-sepia header .bg-gray-600, body.theme-sepia header .bg-yellow-600, body.theme-sepia header .bg-orange-600, body.theme-sepia header .bg-blue-600, body.theme-sepia header .bg-green-600, body.theme-sepia header .bg-purple-600,
       /* ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã®ã€ŒæŠ€ã€ãƒœã‚¿ãƒ³ã¨ã€ŒRollã€ãƒœã‚¿ãƒ³ */
       body.theme-sepia #view-char .bg-gray-500, body.theme-sepia #view-char .bg-orange-500, body.theme-sepia #view-char .bg-emerald-500, body.theme-sepia #view-char .bg-purple-500, body.theme-sepia #view-char .bg-red-600 {
           background-color: #bcaaa4 !important; color: #3e2723 !important; border-color: #a1887f !important;
       }
       body.theme-sepia button:hover, body.theme-sepia .bg-slate-600:hover,
       body.theme-sepia header .bg-gray-600:hover, body.theme-sepia header .bg-yellow-600:hover, body.theme-sepia header .bg-orange-600:hover, body.theme-sepia header .bg-blue-600:hover, body.theme-sepia header .bg-green-600:hover, body.theme-sepia header .bg-purple-600:hover,
       body.theme-sepia #view-char .bg-gray-500:hover, body.theme-sepia #view-char .bg-orange-500:hover, body.theme-sepia #view-char .bg-emerald-500:hover, body.theme-sepia #view-char .bg-purple-500:hover, body.theme-sepia #view-char .bg-red-600:hover { background-color: #a1887f !important; }

       /* 2. ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Teal) */
       body.theme-sepia .bg-blue-700, body.theme-sepia .bg-green-700, body.theme-sepia .bg-teal-600,
       /* ã‚·ãƒŠãƒªã‚ªé€²è¡Œãƒœã‚¿ãƒ³ */
       body.theme-sepia #log-section .bg-indigo-600, body.theme-sepia #log-section .bg-slate-700, body.theme-sepia #log-section .bg-orange-600, body.theme-sepia #log-section .bg-gray-500, body.theme-sepia #log-section .bg-blue-500, body.theme-sepia #log-section .bg-amber-500, body.theme-sepia #log-section .bg-rose-500, body.theme-sepia #log-section .bg-emerald-500,
       /* ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã®ã€Œèƒ½ã€ãƒœã‚¿ãƒ³ */
       body.theme-sepia #view-char .bg-orange-600, body.theme-sepia #view-char .bg-emerald-600, body.theme-sepia #view-char .bg-gray-600, body.theme-sepia #view-char .bg-purple-600, body.theme-sepia #view-char .bg-blue-600 {
           background-color: #00695c !important; color: #e0f2f1 !important; border-color: #004d40 !important;
       }
       body.theme-sepia .bg-blue-700:hover, body.theme-sepia .bg-green-700:hover, body.theme-sepia .bg-teal-600:hover,
       body.theme-sepia #log-section .bg-indigo-600:hover, body.theme-sepia #log-section .bg-slate-700:hover, body.theme-sepia #log-section .bg-orange-600:hover, body.theme-sepia #log-section .bg-gray-500:hover, body.theme-sepia #log-section .bg-blue-500:hover, body.theme-sepia #log-section .bg-amber-500:hover, body.theme-sepia #log-section .bg-rose-500:hover, body.theme-sepia #log-section .bg-emerald-500:hover,
       body.theme-sepia #view-char .bg-orange-600:hover, body.theme-sepia #view-char .bg-emerald-600:hover, body.theme-sepia #view-char .bg-gray-600:hover, body.theme-sepia #view-char .bg-purple-600:hover, body.theme-sepia #view-char .bg-blue-600:hover { background-color: #004d40 !important; }

       /* 3. å±é™ºãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Red) */
       body.theme-sepia .bg-red-700 {
           background-color: #c62828 !important; color: #ffcdd2 !important; border-color: #b71c1c !important;
       }
       body.theme-sepia .bg-red-700:hover { background-color: #b71c1c !important; }

       /* --- Specific Components --- */
       body.theme-sepia details > summary.bg-teal-100 { background-color: #eaddc5 !important; border-bottom: 1px solid #d3c6a6 !important; }
       body.theme-sepia .d66-grid-cell { background-color: #fdf6e3 !important; border-color: #d3c6a6 !important; color: #5d4037 !important; }
       body.theme-sepia .cell-row-0 { background-color: #e0f2f1 !important; color: #004d40 !important; border-color: #b2dfdb !important; }
       body.theme-sepia .cell-row-1 { background-color: #fff8e1 !important; color: #ff6f00 !important; border-color: #ffecb3 !important; }
       body.theme-sepia .cell-row-2 { background-color: #fbe9e7 !important; color: #bf360c !important; border-color: #ffccbc !important; }
       body.theme-sepia .record-table tr.active-row { background-color: #d7ccc8 !important; }
       body.theme-sepia .choice-btn { background-color: #bcaaa4 !important; color: #3e2723 !important; border-color: #a1887f !important; }
       body.theme-sepia #view-char div.border-blue-300.bg-blue-50 { background-color: #d7ccc8 !important; border-color: #bcaaa4 !important; }
       body.theme-sepia #view-char div.border-blue-300.bg-blue-50 span { color: #5d4037 !important; }
    </style>
</head>

<!--â‘¡ç”»é¢è¡¨ç¤º-->
<body class="h-screen flex flex-col">
    <input type="file" id="uploadFile" accept=".json" class="hidden" onchange="handleFileUpload(event)">
    <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleCsvUpload(event)">
    <!--Header-->
    <header class="bg-gray-800 text-white shadow-xl z-10 shrink-0">
    <div class="p-2 px-2 flex items-center gap-2 border-b border-gray-700 h-12 lg:h-auto">
        
        <h1 class="hidden lg:flex text-lg font-bold shrink-0 items-center mr-2">
            ğŸ² RLH Companion
            <button onclick="toggleHelp(true)" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm">?</button>
            <button onclick="toggleSettings(true)" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm">âš™ï¸</button>
        </h1>

        <div class="flex items-center flex-nowrap bg-gray-900 rounded-lg p-1 gap-1 flex-grow overflow-x-auto">
            
            <input type="text" id="logTitle" placeholder="ã‚»ãƒƒã‚·ãƒ§ãƒ³å" 
                   class="bg-transparent border-none focus:ring-0 text-sm font-semibold px-2 flex-grow min-w-[60px] text-white">

            <div class="flex flex-nowrap gap-1 shrink-0">
                <button onclick="document.getElementById('uploadFile').click()" class="bg-green-700 hover:bg-green-600 text-[10px] py-1 px-2 rounded whitespace-nowrap">èª­è¾¼</button>
                <button onclick="downloadData()" class="bg-blue-700 hover:bg-blue-600 text-[10px] py-1 px-2 rounded whitespace-nowrap">ä¿å­˜</button>
                <button onclick="exportLogText()" class="bg-teal-600 hover:bg-teal-500 text-[10px] py-1 px-2 rounded whitespace-nowrap">ãƒ­ã‚°DL</button>
                <button onclick="resetAllData()" class="bg-red-700 hover:bg-red-600 text-[10px] py-1 px-2 rounded whitespace-nowrap">æ¶ˆå»</button>
            </div>
        </div>
        <!-- Mobile-only Help and Settings buttons -->
        <div class="lg:hidden flex items-center gap-1 ml-1">
            <button onclick="toggleHelp(true)" class="bg-gray-600 hover:bg-gray-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm shadow-sm">?</button>
            <button onclick="toggleSettings(true)" class="bg-gray-600 hover:bg-gray-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm shadow-sm">âš™ï¸</button>
        </div>
    </div>
    <div class="p-2 px-4 flex flex-wrap gap-4 items-center bg-gray-700 text-[11px] text-white">
    <div class="flex items-center space-x-2">
        <span>å›æ•°:</span>
        <input type="number" id="rollCount" value="1" class="w-8 rounded text-gray-900 px-1">
        <span>ä¿®æ­£å€¤:</span>
        <input type="number" id="skillValue" value="0" class="w-8 rounded text-gray-900 px-1 text-center">
        <span>ç›®æ¨™å€¤:</span>
        <input type="number" id="targetValue" value="3" class="w-8 rounded text-gray-900 px-1 text-center">
    </div>

    <div class="flex items-center space-x-1 border-l border-gray-600 pl-4">
        <span>ä¿®æ­£:</span>
        <input type="number" id="quickModValue" value="0" class="w-8 rounded text-gray-900 px-1 mr-1">
        <button onclick="handleLocalRoll('1D3', '1D3')" class="bg-gray-600 hover:bg-gray-500 px-1.5 py-0.5 rounded">1D3</button>
        <button onclick="handleLocalRoll('1D6', '1D6')" class="bg-yellow-600 hover:bg-yellow-500 px-1.5 py-0.5 rounded">1D6</button>
        <button onclick="handleLocalRoll('D66', 'D66')" class="bg-orange-600 hover:bg-orange-500 px-1.5 py-0.5 rounded">D66</button>
        <button onclick="handleLocalRoll('D33', 'D33')" class="bg-blue-600 hover:bg-blue-500 px-1.5 py-0.5 rounded">D33</button>
        <button onclick="handleLocalRoll('Treasure', 'å®ç‰©')" class="bg-green-600 hover:bg-green-500 px-1.5 py-0.5 rounded">å®ç‰©</button>
        <button onclick="handleMagicTreasure()" class="bg-purple-600 hover:bg-purple-500 px-1.5 py-0.5 rounded">é­”æ³•ã®å®ç‰©</button>
    </div>
    </div> 
    </header>
    <!--ã‚¿ãƒ–ã‚¹ã‚¤ãƒƒãƒ-->
    <nav class="lg:hidden flex bg-gray-200 border-b border-gray-300 shrink-0">
        <button onclick="switchTab('main')" id="btn-tab-main" class="tab-btn active flex-1 py-2 text-xs font-bold">ãƒ¡ã‚¤ãƒ³/ãƒ­ã‚°</button>
        <button onclick="switchTab('char')" id="btn-tab-char" class="tab-btn flex-1 py-2 text-xs font-bold">ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆ</button>
    </nav>
    <!--Log Section-->
    <main class="flex-1 flex overflow-hidden relative">
        <section id="log-section" class="view-tab active w-full lg:w-2/3 flex flex-col p-4 bg-white overflow-hidden">
            <details class="mb-4 border border-teal-600 rounded-lg bg-teal-50" open>
                <summary class="p-1 font-bold text-teal-800 cursor-pointer text-[10px] bg-teal-100 rounded-t-lg flex justify-between items-center px-3">
                    <span>D66 GRID & SCENARIO</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="event.preventDefault(); document.getElementById('csvUpload').click()" class="bg-slate-600 text-white px-2 rounded">CSVèª­è¾¼</button>
                        <button onclick="event.preventDefault(); resetD66Area()" class="bg-red-600 text-white px-1.5 rounded">CLR</button>
                    </div>
                </summary>
                <div class="p-2 bg-white flex flex-col space-y-2">
                    <div class="flex space-x-1 border-b pb-2">
                   	 <button onclick="playScenario('title')" class="bg-indigo-600 text-white text-[9px] px-2 py-1 rounded">ã‚¿ã‚¤ãƒˆãƒ«</button>
   			 <button onclick="playScenario('rule')" class="bg-slate-700 text-white text-[9px] px-2 py-1 rounded">ç‰¹æ®Šãƒ«ãƒ¼ãƒ«</button>
   			 <button onclick="playScenario('linear')" class="bg-orange-600 text-white text-[9px] px-2 py-1 rounded">ä¸€æœ¬é“ãƒ¢ãƒ¼ãƒ‰</button>
 			 <button onclick="playScenario('pro')" class="bg-gray-500 text-white text-[9px] px-2 py-1 rounded">ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°</button>
    
			 <button onclick="playScenario('start')" class="bg-blue-500 text-white text-[9px] px-2 py-1 rounded">é–‹å§‹</button>
			 <button onclick="playScenario('mid')" class="bg-amber-500 text-white text-[9px] px-2 py-1 rounded">ä¸­é–“</button>
			 <button onclick="playScenario('finish')" class="bg-rose-500 text-white text-[9px] px-2 py-1 rounded">æœ€çµ‚</button>
			 <button onclick="playScenario('clear')" class="bg-emerald-500 text-white text-[9px] px-2 py-1 rounded">é”æˆ</button>

 		   <span id="csvStatus" class="text-[9px] text-gray-400 self-center ml-2 italic">CSVæœªèª­è¾¼</span>
            </div>                    
                        <div class="overflow-x-auto">
                            <table class="record-table">
                                <thead>
        <tr><th style="width: 50px;">å›æ•°</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th></tr>
                                </thead>
                                <tbody id="recordBody"></tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-center space-x-6">
                            <div id="d66Grid" class="d66-grid-container"></div>
                            <div class="text-[10px] text-teal-700 flex flex-col items-center">
                                <span class="font-bold" id="rowLabel">Next (1å›ç›®)</span>
                                <span id="d66NextNumber" class="text-lg font-black bg-teal-700 text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
                            </div>
                        </div>
                    </div>
                </details>

                <div id="log-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-inner">
        <div id="logArea"></div> </div>
        <div id="choice-container" class="hidden"></div>

        <div id="input-control-panel" class="flex-shrink-0 bg-white border-t border-gray-200 pt-2 mt-auto">
        <textarea id="logInput" placeholder="ãƒ­ã‚°å…¥åŠ› (Enterã§é€ä¿¡)" rows="2" class="w-full p-2 border border-gray-300 rounded-md text-sm resize-none focus:ring-2 focus:ring-blue-400 mb-2 shadow-sm"></textarea>
        <div class="flex space-x-2 text-xs pb-2">
            <button onclick="addLogEntry('input')" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow">é€ä¿¡</button>
            <button onclick="addLogEntry('separator')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">åŒºåˆ‡ã‚Šç·š</button>
        </div>
        </div>
        </section>
        <!--Character Section-->
        <section id="view-char" class="view-tab w-full lg:w-1/3 flex flex-col p-4 bg-gray-200 overflow-y-auto custom-scroll border-l border-gray-300 lg:flex">
        <div id="current-character-sheet" class="flex-1 space-y-2">
        </div>
        </section>
    </main>
    <div id="toast-container"></div>

<!--â‘¢ å¸ä»¤å¡”ï¼šJavaScript-->
<script>
        const STORAGE_KEY = 'rlh_final_integrated_v1';
    // --- appState: ã“ã®ã‚¢ãƒ—ãƒªã®**å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå¿ƒè‡“éƒ¨ï¼‰ ---
        let appState = { theme: 'colorful', showToastNotifications: true,
            logTitle: "ã‚»ãƒƒã‚·ãƒ§ãƒ³", logEntries: [], characters: {}, currentCharacterId: null, 
            d66State: [
                { grid: Array(36).fill(0), clickOrder: 1 },
                { grid: Array(36).fill(0), clickOrder: 1 },
                { grid: Array(36).fill(0), clickOrder: 1 }
            ],
            d66Table: Array.from({ length: 3 }, () => Array(13).fill("")), activeRow: 0
        };
        let scenarioMaster = [];
        let logTimeout = null; // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼å¤‰æ•°
    // --- Core Functions ---
    function switchTab(tab) {
        // 1. ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ãƒœã‚¿ãƒ³ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’é™¤å»
        document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
        // 2. è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®IDã‚’æ±ºå®š
        const targetId = (tab === 'main') ? 'log-section' : 'view-' + tab;
        const targetEl = document.getElementById(targetId);
    
        // 3. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        if (targetEl) {targetEl.classList.add('active');}

        // 4. ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        const targetBtn = document.getElementById('btn-tab-' + tab);
        if (targetBtn) {targetBtn.classList.add('active');}
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
    function loadData() {
        const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) { 
                try { 
                    const parsed = JSON.parse(stored);
                    appState = { ...appState, ...parsed };
                } 
                catch(e) { console.error(e); } 
            }

            // --- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ (D66ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—æ•°ä¸è¶³ã‚’ä¿®æ­£) ---
            if (appState.d66Table) {
                // è¡Œæ•°ãŒè¶³ã‚Šãªã„å ´åˆ
                while(appState.d66Table.length < 3) appState.d66Table.push(Array(13).fill(""));
                // åˆ—æ•°ãŒè¶³ã‚Šãªã„å ´åˆ (13åˆ—æœªæº€ãªã‚‰åŸ‹ã‚ã‚‹)
                appState.d66Table.forEach(row => {
                    while(row.length < 13) row.push("");
                });
            }

            if (Object.keys(appState.characters).length === 0) addFromPreset('pc');
            if (!appState.currentCharacterId || !appState.characters[appState.currentCharacterId]) {
                appState.currentCharacterId = Object.keys(appState.characters)[0];
            }
            applyTheme(appState.theme || 'colorful');
            renderAll();
        }

    // --- 1. handleCsvUpload  ---
    function handleCsvUpload(e) {
        const f = e.target.files[0]; 
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã€é«˜åº¦ãªãƒ‘ãƒ¼ã‚¹(parseCSV)ã«æ¸¡ã™
        processCSV(ev.target.result);
        };
        r.readAsText(f);
    }
        // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let scenarioData = {};

    function processCSV(csvText) {
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        scenarioData = {}; // ã‚¯ãƒªã‚¢

        for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const cols = lines[i].split(',').map(c => c.trim());
        // idã‚’ã‚­ãƒ¼ã«ã—ã¦ã€è¡Œå…¨ä½“ã‚’ä¿å­˜
        const row = {};
        headers.forEach((header, index) => {
            row[header] = cols[index] || "";
        });
        const id = row['id'];
        if (id) {scenarioData[id] = row;}
        }
        console.log("Scenario Loaded:", scenarioData);
        document.getElementById('csvStatus').textContent = "CSVèª­è¾¼å®Œäº†";
    }
    // --- 2. è¤‡é›‘ãªCSVã‚’è§£æã™ã‚‹è£œåŠ©é–¢æ•° ---
    function parseCSV(text) {
        const result = [];
        let currentRow = [];
        let currentToken = "";
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    currentToken += '"';
                    i++;
                } 
                else {inQuotes = !inQuotes;}
            } 
            else if (char === ',' && !inQuotes) {
                currentRow.push(currentToken.trim());
                currentToken = "";
            } 
            else if ((char === '\r' || char === '\n') && !inQuotes) {
                if (currentToken !== "" || currentRow.length > 0) {
                    currentRow.push(currentToken.trim());
                    result.push(currentRow);
                    currentRow = [];
                    currentToken = "";
                }
                if (char === '\r' && nextChar === '\n') i++;
            } 
            else {currentToken += char;}
        }
        if (currentToken !== "" || currentRow.length > 0) {
            currentRow.push(currentToken.trim());
            result.push(currentRow);
        }
        return result;
    }

    // --- 3. è§£æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ scenarioMaster ã«æ ¼ç´ã™ã‚‹å‡¦ç† ---
    function processCSV(text) {
        const rows = parseCSV(text);
        if (rows.length < 2) return;

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—
        const headers = rows[0].map(h => h.trim().toLowerCase());
        
        // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
        scenarioMaster = rows.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                let value = row[index] || "";
                // å‰å¾Œã®å¼•ç”¨ç¬¦ã‚’å‰Šé™¤ã—ã€å†…éƒ¨ã®äºŒé‡å¼•ç”¨ç¬¦ã‚’æˆ»ã™
                value = value.replace(/^"(.*)"$/s, '$1').replace(/""/g, '"');
                obj[header] = value;
            });
            
            // turnã‚’æ•°å€¤ã«å¤‰æ› (å¤±æ•—ã—ãŸã‚‰1ã«ã™ã‚‹)
            obj.turn = parseInt(obj.turn) || 1;
            // idã‚’æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒ
            if (obj.id) obj.id = obj.id.toString();
            return obj;
        });

        // ç”»é¢ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        const statusEl = document.getElementById('csvStatus');
        if (statusEl) {
            statusEl.textContent = "èª­è¾¼æ¸ˆ (" + scenarioMaster.length + "ä»¶)";
            statusEl.className = "text-[9px] text-teal-600 self-center ml-2 font-bold";
        }
    }

    // ç›´å‰ã®IDã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°ï¼ˆé–¢æ•°ã®å¤–ã«å®šç¾©ï¼‰
    let previousScenarioId = null;
    
    // ------------------------
    // --- playScenario: CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºã—ã€é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ ---
    // ------------------------
    function playScenario(type, id = null) {
        // IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ç¾åœ¨ã®IDã‚’ã€Œæˆ»ã‚‹ç”¨ã€ã«ä¿å­˜
        // ãŸã ã—ã€d66ã®å‡ºç›®ï¼ˆ11-66ï¼‰ã‚„åˆæœŸè¡¨ç¤ºã®æ™‚ã¯æˆ»ã‚Šå…ˆã¨ã—ã¦æ›´æ–°
        if (id && scenarioData && scenarioData[id]) {
        // ç¾åœ¨ã®è¡¨ç¤ºãŒã€Œæˆ»ã‚‹ã€ã§å‘¼ã³å‡ºã•ã‚ŒãŸã‚‚ã®ã§ãªã„å ´åˆã®ã¿ã€å±¥æ­´ã‚’æ›´æ–°(æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’é€£æ‰“ã—ã¦ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã®ã‚’é˜²ããŸã‚)
        }
        const r = appState.activeRow;
        const turn = r + 1;
        const targetType = type.toLowerCase();

        // --- 1. ç‰¹æ®Šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸­é–“ãƒ»æœ€çµ‚ï¼‰ã®ã‚¿ã‚¤ãƒ«è¨˜éŒ²å‡¦ç† ---
        if (targetType === 'mid' || targetType === 'finish') {
            const label = (targetType === 'mid') ? "ä¸­é–“" : "æœ€çµ‚";
            const emptyIdx = appState.d66Table[r].indexOf("");
            if (emptyIdx !== -1) {
                appState.d66Table[r][emptyIdx] = label;
                renderAll(); 
                saveData();
            }
        }

        // --- 2. æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã“ã“ã‚’æ­£ç¢ºã«ä¿®æ­£ï¼‰ ---
        let entries = [];

        if (id) {
            // IDæŒ‡å®šãŒã‚ã‚‹å ´åˆï¼šãã®ID ä¸”ã¤ (ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ ã¾ãŸã¯ å…±é€šã‚¿ãƒ¼ãƒ³1) ã‚’æ¢ã™
            entries = scenarioMaster.filter(s => String(s.id) === String(id) && parseInt(s.turn) === turn);
            if (entries.length === 0 && turn !== 1) {
                entries = scenarioMaster.filter(s => String(s.id) === String(id) && parseInt(s.turn) === 1);
            }
            // â˜…é‡è¦ï¼šIDã§æ¤œç´¢ã—ãŸçµæœã€1ä»¶ã‚‚ãªã‘ã‚Œã° entries ã¯ç©ºã®ã¾ã¾ã«ã™ã‚‹ã€‚
            // ï¼ˆã“ã“ã§ãƒ˜ã‚¿ã« type æ¤œç´¢ã«æµã•ãªã„ã“ã¨ã§ã€ç„¡é–¢ä¿‚ãªãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’é˜²ãï¼‰
        } 
        if (!id) {
            // IDæŒ‡å®šãŒãªã„å ´åˆã®ã¿ã€ã‚¿ã‚¤ãƒ—ï¼ˆd66ãªã©ï¼‰ã§æ¤œç´¢ã™ã‚‹
            entries = scenarioMaster.filter(s => s.type === targetType && parseInt(s.turn) === turn);
            if (entries.length === 0 && turn !== 1) {
                entries = scenarioMaster.filter(s => s.type === targetType && parseInt(s.turn) === 1);
            }
        }

        // --- 3. ãƒ­ã‚°ã®æ—¥æœ¬èªãƒ©ãƒ™ãƒ«è¨­å®š ---
        const labels = {
            title: "ã‚¿ã‚¤ãƒˆãƒ«",
            rule: "ç‰¹æ®Šãƒ«ãƒ¼ãƒ«",
            linear: "ä¸€æœ¬é“ãƒ¢ãƒ¼ãƒ‰",
            pro: "ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°",
            start: "å†’é™ºã®ã¯ã˜ã¾ã‚Š",
            mid: "ä¸­é–“ã‚¤ãƒ™ãƒ³ãƒˆ",
            clear: "å†’é™ºã®é”æˆ",
            finish: "æœ€çµ‚ã‚¤ãƒ™ãƒ³ãƒˆ",
            magictreasure: "é­”æ³•ã®å®ç‰©",
        };

        // --- 4. ãƒ­ã‚°å‡ºåŠ›å‡¦ç† ---
        let selectedEntry = entries.length > 0 ? entries[0] : null;

        if (targetType === 'd66' && id) {
            // D66ã®å ´åˆï¼šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã€ãªã‘ã‚Œã°ã€Œå‡ºç›®ï¼šXXã€ã®ã¿
            const text = (selectedEntry && selectedEntry.text) ? `\n${selectedEntry.text}` : "";
            addLogEntry('system', 'RESULT', `å‡ºç›®ï¼š${id}${text}`);
            
            // D66ã‚¤ãƒ™ãƒ³ãƒˆã¯åˆ†å²ã®çµ‚ç‚¹ãªã®ã§ã€å¸¸ã«ã€Œæˆ»ã‚‹ã€ã®å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
            previousScenarioId = null;
        }
        else {
            // ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°ã€ä¸­é–“ã‚¤ãƒ™ãƒ³ãƒˆã€ä¸€æœ¬é“ã€åˆ†å²ãªã©ã®å ´åˆ
            const labelName = labels[targetType] || type; 
            // entries ãŒç©ºã§ã‚‚ã€ã‚ã‚‹ã„ã¯ text ãŒç©ºã§ã‚‚ã€ãƒ©ãƒ™ãƒ«ã¯å¿…ãšè¡¨ç¤ºã™ã‚‹
            let contentText = "";
            if (entries.length > 0) {
                contentText = entries.map(e => e.text ? `\n${e.text}` : "").join('');
            }
            // ãƒ©ãƒ™ãƒ«ï¼ˆã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘ãªã©ï¼‰ã‚’ä»˜ã‘ã¦ãƒ­ã‚°ã«å‡ºåŠ›
            addLogEntry('system', 'SCENARIO', `ã€${labelName}ã€‘${contentText}`);
        }

        // --- 5. é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®æç”» ---
        if (selectedEntry) {
            // é­”æ³•ã®å®ç‰©ï¼ˆmagictreasureï¼‰ã®å ´åˆã€é¸æŠè‚¢ãŒãªã‘ã‚Œã°æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’ç¶­æŒã™ã‚‹ï¼ˆæç”»ã—ãªã„ï¼‰
            if (targetType === 'magictreasure') {
                const hasChoice = [1, 2, 3, 4].some(i => selectedEntry[`choice${i}_label`] && selectedEntry[`choice${i}_label`].trim() !== "");
                if (hasChoice) renderChoices(selectedEntry);
            } else {
                renderChoices(selectedEntry);
            }
        } 
        else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯é¸æŠè‚¢ã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹
            const container = document.getElementById('choice-container');
            if (container) container.classList.add('hidden');
        }

        // --- 6. å…¨ä½“ã‚’å†æç”»ã—ã¦ä¿å­˜ ---
        renderAll();
        saveData();
    }


    /*** é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç”»é¢ã«æç”»ã™ã‚‹*/
    function renderChoices(entry) {
        const container = document.getElementById('choice-container');
        if (!container) return;
        container.innerHTML = ''; 
        let hasChoice = false;

        // --- 1. CSVã§å®šç¾©ã•ã‚ŒãŸé€šå¸¸ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ ---
        for (let i = 1; i <= 4; i++) {
            const label = entry[`choice${i}_label`];
            const nextId = entry[`choice${i}_next_id`];

            if (label && label.trim() !== "") {
                hasChoice = true;
                const btn = document.createElement('button');
                btn.className = 'choice-btn'; 
                btn.textContent = label;
                btn.onclick = () => {
                    // ç§»å‹•ã™ã‚‹å‰ã«ã€Œä»Šã®IDã€ã‚’æˆ»ã‚Šå…ˆã¨ã—ã¦ä¿å­˜
                    previousScenarioId = entry.id; 
                    addLogEntry('input', `ï¼ ã€${label}ã€‘ã‚’é¸æŠ`); 
                    container.classList.add('hidden'); 
                    playScenario(label, nextId); 
                };
                container.appendChild(btn);
            }
        }

        // --- 2. ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®åˆ¤å®š ---
        // ã€Œæˆ»ã‚Šå…ˆãŒã‚ã‚‹ã€ã‹ã¤ã€Œä»Šã„ã‚‹å ´æ‰€ãŒæˆ»ã‚Šå…ˆã§ã¯ãªã„ã€ãªã‚‰ã€æœ¬æ¥ã®é¸æŠè‚¢ãŒã‚¼ãƒ­ï¼ˆhasChoiceãŒfalseï¼‰ã§ã‚‚ãƒœã‚¿ãƒ³ã‚’å‡ºã™
        if (previousScenarioId && previousScenarioId !== entry.id) {
            const backBtn = document.createElement('button');
            backBtn.className = 'choice-btn';
            backBtn.style.backgroundColor = "#f3f4f6";
            backBtn.style.borderColor = "#9ca3af";
            backBtn.style.color = "#4b5563";
            backBtn.innerHTML = '<span style="margin-right:4px">â†©</span>æˆ»ã‚‹';
            
            backBtn.onclick = () => {
                addLogEntry('input', `ï¼ ã€æˆ»ã‚‹ã€‘ã‚’é¸æŠ`);
                container.classList.add('hidden');
                
                const targetId = previousScenarioId;
                previousScenarioId = null; // æˆ»ã£ãŸã‚‰å±¥æ­´ã‚’æ¶ˆã™
                playScenario("æˆ»ã‚‹", targetId);
            };
            container.appendChild(backBtn);
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’å‡ºã™ã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã‚’è¡¨ç¤ºå¯¾è±¡ã«ã™ã‚‹
            hasChoice = true; 
        }

        // --- 3. è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ ---
        if (hasChoice || (previousScenarioId && previousScenarioId !== entry.id)) {
            container.classList.remove('hidden');
        } 
        else {
            container.classList.add('hidden');
        }
    }

        // --- é­”æ³•ã®å®ç‰©ï¼ˆCSVæœªç™»éŒ²æ™‚ã¯1D6ã‚’æŒ¯ã‚‹ï¼‰ ---
        function handleMagicTreasure() {
            const c = appState.characters[appState.currentCharacterId];
            const name = c ? c.name : "ï¼Ÿ";
            const turn = appState.activeRow + 1;

            // ä»Šã®å›æ•°ã¾ãŸã¯1å›ç›®ã«ã‚ã‚‹ magictreasure ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const entries = scenarioMaster.filter(s => s.type === 'magictreasure' && (s.turn === turn || s.turn === 1));
            let diceRange = 6; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1D6

            if (entries.length > 0) {
            // CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼šIDã®æœ€å¤§å€¤ã‚’è¦‹ã¦D3ã‹D6ã‹åˆ¤åˆ¥
                const maxId = Math.max(...entries.map(s => parseInt(s.id) || 0));
                diceRange = (maxId > 3) ? 6 : 3;
            } 
            else {
            // CSVã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼šãã®ã¾ã¾1D6
            diceRange = 6;
            }

            const roll = Math.floor(Math.random() * diceRange) + 1;
            addLogEntry('dice', 'é­”æ³•ã®å®ç‰©', `[å®Ÿè¡Œè€…: ${name}] 1D${diceRange}(${roll})`);

            // CSVãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ playScenario ã‚’å‘¼ã³å‡ºã™
            if (entries.length > 0) {
                playScenario('magictreasure', roll.toString());
            } 
        }
    
    // ------------------------
    // --- D66 Grid logic -----
    // ------------------------
    function renderD66Grid() {
        const gridEl = document.getElementById('d66Grid');
        gridEl.innerHTML = Array(36).fill(0).map((_, i) => {
            let cls = "d66-grid-cell", tags = "";
                appState.d66State.forEach((state, rIdx) => {
                    if (state.grid[i] > 0) {
                        cls += ` cell-row-${rIdx}`;
                        tags += `<span class="d66-order-tag" style="top:${rIdx*5}px; right:1px;">${state.grid[i]}</span>`;
                    }
                });
                return `<div class="${cls}" onclick="hD66(${i})"><span>${Math.floor(i/6)+1}${i%6+1}</span>${tags}</div>`;
            }).join('');
            document.getElementById('d66NextNumber').textContent = appState.d66State[appState.activeRow].clickOrder;
            document.getElementById('rowLabel').textContent = `Next (${appState.activeRow + 1}å›ç›®)`;
    }

        // --- hD66: D66ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç† ---
        function hD66(i) {
            const r = appState.activeRow;
            const val = `${Math.floor(i/6)+1}${(i%6)+1}`;
            // åŒã˜è¡Œã®ä¸­ã§ã®ã¿ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
            if (appState.d66State[r].grid[i] > 0) {
                const order = appState.d66State[r].grid[i];
                appState.d66State[r].grid[i] = 0;
                appState.d66State[r].grid = appState.d66State[r].grid.map(v => v > order ? v-1 : v);
                appState.d66State[r].clickOrder--;
                appState.d66Table[r] = appState.d66Table[r].map(c => c === val ? "" : c);
            } 
            else {
                appState.d66State[r].grid[i] = appState.d66State[r].clickOrder++;
                const emptyIdx = appState.d66Table[r].indexOf("");
                if (emptyIdx !== -1) appState.d66Table[r][emptyIdx] = val;
                playScenario('d66', val);
            }
            renderAll(); saveData();
        }

        function renderD66Table() {
            const body = document.getElementById('recordBody');
            body.innerHTML = appState.d66Table.map((row, rIdx) => `
                <tr class="${appState.activeRow === rIdx ? 'active-row' : ''}">
                    <td class="bg-gray-100 font-bold"><input type="radio" name="rowSel" ${appState.activeRow === rIdx ? 'checked' : ''} onchange="appState.activeRow=${rIdx}; renderAll(); saveData();"> ${rIdx+1}</td>
                    ${row.map((cell, cIdx) => `<td onclick="clearTableCell(${rIdx},${cIdx})" class="cursor-pointer">${cell}</td>`).join('')}
                </tr>`).join('');
        }

        function clearTableCell(r, c) {
            const val = appState.d66Table[r][c];
            if (val && !isNaN(val)) {
                const i = (parseInt(val[0])-1)*6 + (parseInt(val[1])-1);
                const order = appState.d66State[r].grid[i];
                appState.d66State[r].grid[i] = 0;
                appState.d66State[r].grid = appState.d66State[r].grid.map(v => v > order ? v-1 : v);
                appState.d66State[r].clickOrder--;
            }
            appState.d66Table[r][c] = ""; renderAll(); saveData();
        }

        function resetD66Area() {
            if(confirm("D66ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                appState.d66State = appState.d66State.map(() => ({ grid: Array(36).fill(0), clickOrder: 1 }));
                appState.d66Table = [Array(13).fill(""), Array(13).fill(""), Array(13).fill("")];
                renderAll(); saveData();
            }
        }

    // ------------------------    
    // --- Resource & Character Logic ---
    // ------------------------
    const PRESETS = {
        pc: { name: 'ä¸»äººå…¬', icon: 'ğŸ‘¤', level: 10, skill: 0, life: 4, lifeMax: 4, lifeType: 'hp', lifeLabel: 'ç”Ÿå‘½', subType: 'luck', subLabel: 'å¹¸é‹', subVal: 2, subMax: 2, follower: 7, food: 2, gold: 10, clue: 0, memo: '' },
        soldier: { name: 'å…µå£«', icon: 'âš”ï¸', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'str', subLabel: 'ç­‹åŠ›', subVal: 0, subMax: 0, memo: 'æˆ¦ã†å¾“è€…' },
        swordsman: { name: 'å‰£å£«', icon: 'âš”ï¸', level: 4, skill: 1, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'str', subLabel: 'ç­‹åŠ›', subVal: 0, subMax: 0, memo: 'æˆ¦ã†å¾“è€…' },
        archer: { name: 'å¼“å…µ', icon: 'ğŸ¹', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'dex', subLabel: 'å™¨ç”¨', subVal: 0, subMax: 0, rangedMod: 1, meleeMod: -1, memo: 'æˆ¦ã†å¾“è€…ï¼šé éš”æ”»æ’ƒ+1ã€è¿‘æ¥æ”»æ’ƒ-1' },
        mage: { name: 'é­”è¡“å¸«', icon: 'ğŸ§™', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'mag', subLabel: 'é­”è¡“', subVal: 1, subMax: 1, memo: 'æˆ¦ã†å¾“è€…ï¼šäººæ•°ï¼é­”è¡“ç‚¹' },
        scout: { name: 'æ–¥å€™', icon: 'ğŸ•¯ï¸', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'dex', subLabel: 'å™¨ç”¨', subVal: 0, subMax: 0, memo: 'æˆ¦ã‚ãªã„å¾“è€…' },
        porter: { name: 'è·ç‰©æŒã¡', icon: 'ğŸ’', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'str', subLabel: 'ç­‹åŠ›', subVal: 0, subMax: 0, memo: 'æˆ¦ã‚ãªã„å¾“è€…' },
        lantern: { name: 'ãƒ©ãƒ³ã‚¿ãƒ³æŒã¡', icon: 'ğŸ®', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'luck', subLabel: 'å¹¸é‹', subVal: 0, subMax: 0, memo: 'æˆ¦ã‚ãªã„å¾“è€…' },
        tachi_mochi: { name: 'å¤ªåˆ€æŒã¡', icon: 'ğŸ—¡ï¸', level: 4, skill: 0, life: 1, lifeMax: 1, lifeType: 'num', lifeLabel: 'äººæ•°', subType: 'str', subLabel: 'ç­‹åŠ›', subVal: 0, subMax: 0, memo: 'æˆ¦ã‚ãªã„å¾“è€…' },
        strong_creature: { name: 'å¼·ã„ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼', icon: 'ğŸ‘¹', level: 4, skill: 0, life: 7, lifeMax: 7, lifeType: 'hp', lifeLabel: 'ç”Ÿå‘½', subType: 'num', subLabel: 'æ”»æ’ƒæ•°', subVal: 1, subMax: 1, memo: '' },
        weak_creature: { name: 'å¼±ã„ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼', icon: 'ğŸ‘»', level: 4, skill: 0, life: 3, lifeMax: 3, lifeType: 'app', lifeLabel: 'å‡ºç¾æ•°', subType: 'luck', subLabel: 'å¹¸é‹', subVal: 0, subMax: 0, memo: '' }
    };

    function addFromPreset(key) {
        const p = PRESETS[key];
        if (!p) return;

        const newId = 'char_' + Date.now();
        
        let deleted = [];
        if (key !== 'pc') {
            deleted = ['follower', 'food', 'clue', 'gold'];
        }
        if (key === 'strong_creature' || key === 'weak_creature') {
            deleted.push('skill');
            if (key === 'weak_creature') {
                deleted.push('subAbility');
            }
        }

        appState.characters[newId] = {
            id: newId,
            name: p.name,
            data: {
                level: p.level,
                icon: p.icon,
                skill: p.skill,
                life: { current: p.life, max: p.lifeMax, type: p.lifeType, label: p.lifeLabel },
                subAbility: { current: p.subVal, max: p.subMax, type: p.subType, label: p.subLabel },
                follower: { current: p.follower || 0, max: p.follower || 0 },
                food: p.food || 0,
                clue: p.clue || 0,
                gold: p.gold || 0,
                memo: p.memo,
                meleeMod: p.meleeMod || 0,
                rangedMod: p.rangedMod || 0,
                armorMod: p.armorMod || 0,
                magicResistMod: p.magicResistMod || 0,
                lifeMod: p.lifeMod || 0,
                abilityMods: { luck: 0, str: 0, mag: 0, dex: 0 }
            },
            customResources: [],
            deletedResources: deleted
        };
        // é †åºé…åˆ—ã®æœ«å°¾ã«è¿½åŠ 
        if (!appState.characterOrder) appState.characterOrder = Object.keys(appState.characters);
        if (!appState.characterOrder.includes(newId)) appState.characterOrder.push(newId);

        appState.currentCharacterId = newId;
        renderCurrentCharacterSheet();
        saveData();
    }
        //onResChange: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰ãˆãŸã¨ãã«**ã€Œ0.5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ­ã‚°ã‚’å‡ºã™ã€é€£æ‰“é˜²æ­¢æ©Ÿèƒ½
        function onResChange(key, label, val, isMax=false,id=appState.currentCharacterId) {
            const c = appState.characters[id];
            if (!c) return;

            // å¤‰æ›´å‰ã®å€¤ã‚’è¨˜éŒ²ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ãªã„æ™‚ã ã‘å–å¾—ï¼‰
            if (!c._oldValues) c._oldValues = {};
            const storageKey = `${key}_${isMax}`;
            if (c._oldValues[storageKey] === undefined) {
                c._oldValues[storageKey] = isMax ? c.data[key].max : (typeof c.data[key] === 'object' ? c.data[key].current : c.data[key]);
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆã“ã“ã¯å³åº§ã«è¡Œã†ï¼‰
            if(isMax) c.data[key].max = parseInt(val); 
            else if(typeof c.data[key] === 'object') c.data[key].current = parseInt(val);
            else c.data[key] = parseInt(val);
            saveData();
            // ãƒ­ã‚°å‡ºåŠ›ã®äºˆç´„ï¼ˆ500msä»¥å†…ã«æ¬¡ã®æ“ä½œãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å†äºˆç´„ï¼‰
            clearTimeout(logTimeout);
            logTimeout = setTimeout(() => {
                const oldVal = c._oldValues[storageKey];
                const newVal = parseInt(val);
                if (oldVal != newVal) {
                    addLogEntry('system', '', `[${c.name}] ${label}${isMax?'(æœ€å¤§)':''}: ${oldVal} -> ${newVal}`);
                }
                // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ
                delete c._oldValues[storageKey];
            }, 500); // 0.5ç§’é–“æ“ä½œãŒæ­¢ã¾ã£ãŸã‚‰ãƒ­ã‚°ã‚’å‡ºã™
        }
        function onCustomResChange(id, idx, val, isMax) {
            const c = appState.characters[id];
            const res = c.customResources[idx];
            const oldVal = isMax ? res.max : res.current;
            // å€¤ã®æ›´æ–°
                if(isMax) res.max = parseInt(val);
                else res.current = parseInt(val);
            saveData();
            // ãƒ­ã‚°å‡ºåŠ›ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
            clearTimeout(logTimeout);
            logTimeout = setTimeout(() => {
                if (oldVal != parseInt(val)) {
                addLogEntry('system', '', `[${c.name}] ${res.name}${isMax?'(æœ€å¤§)':''}: ${oldVal} -> ${val}`);
                }
            }, 500);
        }
    // èƒ½åŠ›ä¿®æ­£å€¤ã‚’ä¿å­˜ã™ã‚‹è£œåŠ©é–¢æ•°
    function updateAbilityMod(id, key, val) {
        if (!appState.characters[id].data.abilityMods) {
        appState.characters[id].data.abilityMods = {};
        }
        appState.characters[id].data.abilityMods[key] = parseInt(val) || 0;
        saveData();// ãƒ­ã‚°ã«ã¯å‡ºã•ãšã€é™ã‹ã«æ›´æ–°ï¼ˆé »ç¹ã«å¤‰ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”Ÿå‘½ç‚¹æ“ä½œç”¨
    function updateHeaderLife(id, delta) {
        const c = appState.characters[id];
        if (!c) return;
        const target = c.data.life;
        const oldV = parseInt(target.current) || 0;
        let newV = oldV + delta;
        if (newV < 0) newV = 0;
        if (newV > target.max) newV = target.max;
        if (oldV !== newV) {
             onResChange('life', target.label, newV, false, id);
             renderCurrentCharacterSheet();
        }
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰ã‚’ç®¡ç†ã—ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    function handleAccordionToggle(event, id) {
        const detailsElement = event.target;

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãŒé–‹ã‹ã‚ŒãŸæ™‚ã ã‘å‡¦ç†ã‚’å®Ÿè¡Œ
        if (detailsElement.open) {
            // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ãªã‘ã‚Œã°ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¦å†æç”»ã™ã‚‹
            if (appState.currentCharacterId !== id) {
                appState.currentCharacterId = id;
                renderCurrentCharacterSheet();
            }
        }
    }
    //â‘  renderCurrentCharacterSheetï¼ˆã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã®è‡ªå‹•ç”Ÿæˆï¼‰
function renderCurrentCharacterSheet() {
    const container = document.getElementById('current-character-sheet');
    if (!container) return;

    // --- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºãƒœã‚¿ãƒ³ï¼‰ ---
    let h = `<div class="flex justify-end items-center mb-2 gap-2 px-1">
        <button onclick="toggleAllCharSelection()" class="text-[10px] text-gray-500 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">å…¨é¸æŠ/è§£é™¤</button>
        <button onclick="pickRandomChar()" class="bg-indigo-600 text-white text-[10px] px-2 py-1 rounded font-bold shadow hover:bg-indigo-700">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º</button>
    </div>`;

    // --- é †åºé…åˆ—ã®åˆæœŸåŒ–ã¨æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ---
    if (!appState.characterOrder) appState.characterOrder = Object.keys(appState.characters);
    // å­˜åœ¨ã—ãªã„IDã‚’é™¤å»ã—ã€æœªç™»éŒ²ã®IDã‚’è¿½åŠ 
    appState.characterOrder = appState.characterOrder.filter(id => appState.characters[id]);
    Object.keys(appState.characters).forEach(id => {
        if (!appState.characterOrder.includes(id)) appState.characterOrder.push(id);
    });

    // 1. å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ (é †åºé…åˆ—ã‚’ä½¿ç”¨)
    appState.characterOrder.forEach((id, index) => {
        const c = appState.characters[id];
        if (!c) return;
        const d = c.data;

        // --- ãƒ‡ãƒ¼ã‚¿è£œå®Œ ---
        if (!d.abilities) {
            d.abilities = { luck: { name: 'å¹¸é‹', base: 0 }, str:  { name: 'ç­‹åŠ›', base: 0 }, mag:  { name: 'é­”è¡“', base: 0 }, dex:  { name: 'å™¨ç”¨', base: 0 } };
            if (d.subAbility && d.subAbility.type && d.abilities[d.subAbility.type]) {
                d.abilities[d.subAbility.type].base = d.subAbility.current || 0;
            }
        }
        if (!d.abilityMods) d.abilityMods = { luck: 0, str: 0, mag: 0, dex: 0 };
        if (d.meleeMod === undefined) d.meleeMod = 0;
        if (d.rangedMod === undefined) d.rangedMod = 0;
        if (d.armorMod === undefined) d.armorMod = 0;
        if (!c.customResources) c.customResources = [];
        if (!c.deletedResources) c.deletedResources = [];
        if (c.isSelected === undefined) c.isSelected = false;
        if (c.isExpanded === undefined) c.isExpanded = false;

        // --- çŠ¶æ…‹åˆ¤å®š ---
        const isActive = (id === appState.currentCharacterId);
        const activeClass = isActive ? "bg-indigo-50 border-indigo-500 ring-1 ring-indigo-300" : "bg-white border-gray-300 hover:border-indigo-300";

        // --- ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®é–‹å§‹ (detailsè¦ç´ ) ---
        // ontoggleã§ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’å»ƒæ­¢ã—ã€é–‹é–‰çŠ¶æ…‹ã®ä¿å­˜ã®ã¿ã‚’è¡Œã†
        h += `<details id="char-card-${id}" class="group mb-3 rounded-lg shadow-sm overflow-hidden border transition-all ${activeClass}" ${c.isExpanded ? "open" : ""} 
            ontoggle="appState.characters['${id}'].isExpanded = this.open; saveData();"
            ondragover="handleDragOver(event)" 
            ondrop="handleDrop(event, '${id}')"
            ondragleave="handleDragLeave(event)">
            <summary class="relative flex items-center justify-between p-3 pr-8 cursor-pointer list-none hover:bg-opacity-80 transition-colors select-none"
                onclick="event.preventDefault(); setActiveCharacter('${id}')">

                <div class="flex items-center flex-grow min-w-0 gap-2">
                    
                    <!-- åå‰å…¥åŠ› -->
                    <input type="text" value="${c.name || ''}" 
                        class="font-bold text-gray-800 bg-transparent border-b border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none w-full transition-all text-sm" 
                        onclick="event.stopPropagation();" 
                        onchange="appState.characters['${id}'].name=this.value; saveData();" 
                        placeholder="åå‰...">
                </div>

                <!-- ç”Ÿå‘½ç‚¹æ“ä½œ (ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’æ­¢ã‚ã‚‹) -->
                <div class="flex items-center ml-2 pl-2 border-l border-gray-200 shrink-0 gap-2" onclick="event.preventDefault(); event.stopPropagation();">
                    <span class="text-[9px] text-gray-400 mr-1">Lv.</span>
                    <input type="number" value="${d.level || 10}" 
                        class="w-8 text-center text-[11px] font-bold bg-transparent focus:outline-none border-b border-transparent hover:border-blue-300"
                        onclick="event.stopPropagation();"
                        onchange="const val = parseInt(this.value) || 1; appState.characters['${id}'].data.level=val; saveData(); addLogEntry('system', '', \`[\${appState.characters['${id}'].name}] ãƒ¬ãƒ™ãƒ«ãŒ \${val} ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ\`);">
                    
                    <div class="flex items-center text-red-600 font-bold bg-red-50 px-1 rounded border border-red-100">
                        <span class="mr-1 text-[9px]">â¤ï¸</span>
                        <button onclick="updateHeaderLife('${id}', -1)" class="w-5 h-5 flex items-center justify-center bg-white border border-red-200 hover:bg-red-100 rounded text-[10px] leading-none">-</button>
                        <span class="life-display mx-1 min-w-[20px] text-center">${d.life.current}/${d.life.max}</span>
                        <button onclick="updateHeaderLife('${id}', 1)" class="w-5 h-5 flex items-center justify-center bg-white border border-red-200 hover:bg-red-100 rounded text-[10px] leading-none">+</button>
                    </div>
                </div>

                <!-- Drag Handle (Hoverã§è¡¨ç¤º) -->
                <div draggable="true" ondragstart="handleDragStart(event, '${id}')" ondragend="handleDragEnd(event)" 
                     class="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-400 opacity-0 group-hover:opacity-100 hover:text-gray-700 drag-handle"
                     onclick="event.stopPropagation()" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </div>
            </summary>
            <div class="p-3 border-t border-gray-100 flex flex-col items-stretch gap-4 w-full">`;

        // --- å†…éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼: ä¸¦ã³æ›¿ãˆ & ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚§ãƒƒã‚¯ ---
        h += `<div class="flex justify-end items-center mb-1">
            <label class="flex items-center text-[10px] cursor-pointer select-none px-2 hover:text-indigo-700">
                <input type="checkbox" class="mr-1 h-3 w-3 accent-indigo-600" 
                    ${c.isSelected ? 'checked' : ''} 
                    onchange="toggleCharSelection('${id}')">
                <span>ãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºå¯¾è±¡</span>
            </label>
        </div>`;

        const resourceConfigs = [
            {id:'skill', l:'æŠ€é‡ç‚¹', bg:'yellow', type:'single'}, {id:'life', l:'ç”Ÿå‘½ç‚¹', bg:'red', type:'sub-life'}, {id:'subAbility', l:'èƒ½åŠ›', bg:'blue', type:'sub'}, {id:'follower', l:'å¾“è€…', bg:'green', type:'dual'}, {id:'food', l:'é£Ÿæ–™', bg:'orange', type:'single'}, {id:'clue', l:'æ‰‹ãŒã‹ã‚Š', bg:'indigo', type:'single'}, {id:'gold', l:'é‡‘è²¨', bg:'amber', type:'single'}
        ];
        const mainRes = resourceConfigs.slice(0, 4);
        const subRes = resourceConfigs.slice(4);

        // 1. ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹ (2åˆ—)
        h += `<div class="grid grid-cols-2 gap-1 w-full">`;
        mainRes.forEach(res => {
            if(c.deletedResources.includes(res.id)) return;
            const isSpecial = (res.type === 'sub-life' || res.type === 'sub');
            const target = isSpecial ? (res.type === 'sub-life' ? d.life : d.subAbility) : null;
            const val = d[res.id];
            let logLabel = res.l;
            if (isSpecial && target) { logLabel = target.label; }

            h += `<div class="bg-${res.bg}-50 border border-${res.bg}-200 p-0.5 rounded flex items-center justify-between group h-9 shadow-sm w-full">
                <div class="flex-grow min-w-0 pr-1">
                    ${isSpecial ? `<div class="relative flex items-center">
                            <select class="font-bold bg-transparent w-full focus:outline-none cursor-pointer text-gray-700 text-[11px] appearance-none pr-4 z-10" onchange="event.stopPropagation(); const ch=appState.characters['${id}']; const t=ch.data.${res.type==='sub-life'?'life':'subAbility'}; t.type=this.value; t.label=this.options[this.selectedIndex].text; renderCurrentCharacterSheet(); saveData();">
                                ${(res.type==='sub-life' ? [{v:'hp',t:'ç”Ÿå‘½'},{v:'num',t:'äººæ•°'},{v:'app',t:'å‡ºç¾æ•°'}] : [{v:'luck',t:'å¹¸é‹'},{v:'str',t:'ç­‹åŠ›'},{v:'mag',t:'é­”è¡“'},{v:'dex',t:'å™¨ç”¨'}]).map(opt => `<option value="${opt.v}" ${target.type===opt.v?'selected':''}>${opt.t}</option>`).join('')}
                            </select>
                            <div class="absolute right-0 pointer-events-none text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg></div>
                        </div>` : `<span class="font-bold text-gray-600 text-[11px] truncate pl-1">${res.l}</span>`}
                </div>
                <div class="flex items-center space-x-1">
                    <div class="flex items-center bg-white/50 rounded border border-${res.bg}-100 px-1">
                        ${isSpecial || res.type === 'dual' ? `<input type="number" value="${isSpecial ? target.current : (val?.current||0)}" ${isSpecial && res.type==='sub-life' ? 'data-res-key="life.current"' : ''} class="w-9 text-center text-[11px] font-bold bg-transparent outline-none" onchange="onResChange('${isSpecial?(res.type==='sub-life'?'life':'subAbility'):res.id}', '${logLabel}', this.value, false, '${id}')"><span class="text-gray-400 text-[10px]">/</span><input type="number" value="${isSpecial ? target.max : (val?.max||0)}" class="w-9 text-center text-[11px] bg-transparent text-gray-400 outline-none" onchange="onResChange('${isSpecial?(res.type==='sub-life'?'life':'subAbility'):res.id}', '${logLabel}', this.value, true, '${id}')">` : `<input type="number" value="${val||0}" class="w-10 text-center text-[11px] font-bold bg-transparent outline-none" onchange="onResChange('${res.id}', '${res.l}', this.value, false, '${id}')">`}
                    </div>
                    <button onclick="event.stopPropagation(); appState.characters['${id}'].deletedResources.push('${res.id}'); renderCurrentCharacterSheet(); saveData();" class="text-red-300 hover:text-red-500 hidden group-hover:block transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>`;
        });
        h += `</div>`;

        // 2. ã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹ & ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ (3åˆ—)
        h += `<div class="grid grid-cols-3 gap-1 w-full mt-1">`;
        subRes.forEach(res => {
            if(c.deletedResources.includes(res.id)) return;
            const val = d[res.id];
            h += `<div class="bg-${res.bg}-50 border border-${res.bg}-200 p-0.5 rounded flex items-center justify-between h-8 shadow-sm w-full group gap-1">
                    <span class="font-bold text-gray-600 text-[10px] pl-1 truncate">${res.l}</span>
                    <div class="flex items-center space-x-1">
                        <div class="flex items-center bg-white/50 rounded border border-${res.bg}-100 px-1">
                            <input type="number" value="${val||0}" class="w-10 text-center text-[11px] font-bold bg-transparent outline-none" onchange="onResChange('${res.id}', '${res.l}', this.value, false, '${id}')">
                        </div>
                        <button onclick="event.stopPropagation(); appState.characters['${id}'].deletedResources.push('${res.id}'); renderCurrentCharacterSheet(); saveData();" class="text-red-300 hover:text-red-500 hidden group-hover:block transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>`;
        });
        if (c.customResources) {
            c.customResources.forEach((res, idx) => {
                h += `<div class="bg-purple-50 border border-purple-200 p-0.5 rounded flex items-center justify-between h-8 shadow-sm w-full group gap-1">
                        <input type="text" value="${res.name}" class="font-bold text-purple-700 bg-transparent flex-grow min-w-0 focus:outline-none text-[10px] pl-1" onchange="appState.characters['${id}'].customResources[${idx}].name=this.value; saveData();">
                        <div class="flex items-center space-x-1">
                            <div class="flex items-center bg-white/50 rounded border border-purple-100 px-1">
                                <input type="number" value="${res.current}" class="w-10 text-center text-[11px] font-bold bg-transparent outline-none text-purple-800" onchange="onCustomResChange('${id}', ${idx}, this.value, false)">
                            </div>
                            <button onclick="event.stopPropagation(); appState.characters['${id}'].customResources.splice(${idx},1); renderCurrentCharacterSheet(); saveData();" class="text-red-300 hover:text-red-500 hidden group-hover:block transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>`;
            });
        }
        h += `</div>`;
       
        // --- 1-2. æˆ¦é—˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ«ã®ç”Ÿæˆ ---
        h += `<div class="pt-2 border-t border-gray-100 w-full">
                <p class="text-[10px] font-bold text-orange-600 mb-2 pl-1">âš”ï¸ æˆ¦é—˜ãƒ»ç‰¹æ®Šåˆ¤å®š</p>
                <div class="grid grid-cols-2 gap-1 w-full">`;

        const canMagicAbility = (d.subAbility.type === 'mag' || d.subAbility.type === 'luck');
        const actions = [
            {k:'meleeMod', l:'æ¥è¿‘', c:'orange', t:'æ¥è¿‘', hasAbility: true, hasSkill: true}, {k:'rangedMod', l:'é éš”', c:'emerald', t:'é è·é›¢', hasAbility: true, hasSkill: true}, {k:'armorMod', l:'é˜²å¾¡', c:'gray', t:'é˜²å¾¡', hasAbility: true, hasSkill: true}, {k:'magicResistMod', l:'å¯¾é­”', c:'purple', t:'å¯¾é­”æ³•', hasAbility: canMagicAbility, hasSkill: true}, {k:'lifeMod', l:'ç”Ÿå‘½', c:'red', t:'ç”Ÿå‘½', hasAbility: true, hasSkill: false}
        ];

        actions.forEach(item => {
            h += `<div class="bg-${item.c}-50 border border-${item.c}-200 p-0.5 rounded flex items-center justify-between h-9 shadow-sm w-full">
                    <span class="text-[11px] font-bold text-${item.c}-700 pl-1">${item.l}</span>
                    <div class="flex items-center space-x-1">
                        <span class="text-[9px] text-${item.c}-400">ä¿®:</span>
                        <input type="number" value="${d[item.k] || 0}" class="w-8 text-center text-[11px] font-bold bg-white border border-${item.c}-100 rounded outline-none" onchange="onResChange('${item.k}', '${item.l}ä¿®æ­£', this.value, false, '${id}')">
                        <div class="flex gap-1 ml-1">
                            ${item.hasAbility ? `<button onclick="event.stopPropagation(); handleActionRoll('${id}', '${item.t}', 'ability')" class="w-7 h-7 bg-${item.c}-600 text-white text-[10px] rounded font-bold shadow-sm hover:bg-${item.c}-700 transition-colors">${item.hasSkill ? 'èƒ½' : 'Roll'}</button>` : ''}
                            ${item.hasSkill ? `<button onclick="event.stopPropagation(); handleActionRoll('${id}', '${item.t}', 'skill')" class="w-7 h-7 bg-${item.c}-500 text-white text-[10px] rounded font-bold shadow-sm hover:bg-${item.c}-600 transition-colors">æŠ€</button>` : ''}
                        </div>
                    </div>
                </div>`;
        });
        h += `</div></div>`;

        // --- ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šèƒ½åŠ›åˆ¤å®šï¼ˆ4ã¤ã®åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã€‘ ---
        h += `<div class="pt-2 border-t border-gray-100 w-full">
                <p class="text-[10px] font-bold text-blue-500 mb-2 pl-1">ğŸ’ èƒ½åŠ›åˆ¤å®š (å·¦:å‰¯èƒ½åŠ›ä¿®æ­£ / å³:æŠ€é‡ãƒ­ãƒ¼ãƒ«)</p>
                <div class="grid grid-cols-2 gap-1 w-full">
                    ${['luck', 'str', 'mag', 'dex'].map(key => {
                        const names = {luck:'å¹¸é‹', str:'ç­‹åŠ›', mag:'é­”è¡“', dex:'å™¨ç”¨'};
                        const mod = d.abilityMods[key] || 0;
                        const isSelected = (d.subAbility && d.subAbility.type === key);
                        return `<div class="flex items-center justify-between border ${isSelected ? 'border-blue-300 bg-blue-50' : 'border-gray-100 bg-white'} p-0.5 rounded h-9 shadow-sm w-full">
                                <span class="text-[11px] font-bold w-5 text-center ${isSelected ? 'text-blue-700' : 'text-gray-300'}">${names[key].charAt(0)}</span>
                                <div class="flex items-center space-x-1">
                                    <span class="text-[9px] text-blue-400">ä¿®:</span>
                                    <input type="number" value="${mod}" class="w-7 text-center text-[11px] border-b border-blue-200 bg-transparent outline-none" onchange="updateAbilityMod('${id}', '${key}', this.value)">
                                    <div class="flex gap-1 ml-1">
                                        <button onclick="event.stopPropagation(); handleActionRoll('${id}', '${names[key]}', 'ability')" class="w-7 h-7 ${isSelected ? 'bg-blue-600' : 'bg-gray-200 text-gray-400'} text-white text-[10px] rounded font-bold" ${!isSelected ? 'disabled' : ''}>èƒ½</button>
                                        <button onclick="event.stopPropagation(); handleActionRoll('${id}', '${names[key]}', 'skill')" class="w-7 h-7 bg-gray-500 text-white text-[10px] rounded font-bold">æŠ€</button>
                                    </div>
                                </div>
                            </div>`;
                    }).join('')}
                </div>
            </div>`;

        // --- ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šãƒ¡ãƒ¢ ï¼† ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ã€‘ ---
        h += `<textarea class="w-full text-[12px] border border-gray-200 h-28 p-2 rounded-md focus:ring-1 focus:ring-blue-400 focus:outline-none bg-yellow-50/30" placeholder="ãƒ¡ãƒ¢ãƒ»æ‰€æŒå“" onclick="event.stopPropagation();" onchange="appState.characters['${id}'].data.memo=this.value; saveData();">${d.memo || ""}</textarea>
            <div class="grid grid-cols-4 gap-2 w-full pb-2">
                <button onclick="event.stopPropagation(); addCustomResourceTo('${id}')" class="bg-purple-100 text-purple-700 hover:bg-purple-200 text-[10px] py-2 rounded font-bold">ï¼‹ é …ç›®</button>
                <button onclick="event.stopPropagation(); downloadCharacterById('${id}')" class="bg-blue-100 text-blue-700 hover:bg-blue-200 text-[10px] py-2 rounded font-bold">ğŸ’¾ ä¿å­˜</button>
                <button onclick="event.stopPropagation(); if(confirm('å…¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { appState.characters['${id}'].deletedResources=[]; renderCurrentCharacterSheet(); saveData(); }" class="text-[10px] text-gray-400 bg-gray-50 py-2 rounded border border-gray-100">ãƒªã‚»ãƒƒãƒˆ</button>
                <button onclick="event.stopPropagation(); if(confirm('${c.name} ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) { deleteCharacter('${id}'); }" class="text-[10px] text-red-400 bg-red-50 py-2 rounded border border-red-100">å‰Šé™¤</button>
            </div>
        </div> </details> `;
    });

    // 2. ã€Œæ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³
    h += `<div class="mt-4">
        <select onchange="if(this.value){ addFromPreset(this.value); this.value=''; }" class="w-full p-3 bg-blue-600 text-white rounded-lg font-bold text-sm cursor-pointer shadow-md appearance-none text-center">
            <option value="">ï¼‹ æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼/å¾“è€…ã‚’è¿½åŠ </option>
            <option value="pc">ğŸ‘¤ ä¸»äººå…¬</option>
            <option value="soldier">âš”ï¸ å…µå£«</option>
            <option value="swordsman">âš”ï¸ å‰£å£«</option>
            <option value="archer">ğŸ¹ å¼“å…µ</option>
            <option value="mage">ğŸ§™ é­”è¡“å¸«</option>
            <option value="scout">ğŸ•¯ï¸ æ–¥å€™</option>
            <option value="porter">ğŸ’ è·ç‰©æŒã¡</option>
            <option value="lantern">ğŸ® ãƒ©ãƒ³ã‚¿ãƒ³æŒã¡</option>
            <option value="tachi_mochi">ğŸ—¡ï¸ å¤ªåˆ€æŒã¡</option>
            <option value="strong_creature">ğŸ‘¹ å¼·ã„ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼</option>
            <option value="weak_creature">ğŸ‘» å¼±ã„ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼</option>
        </select>
    </div>`;

    // 3. ç”Ÿæˆã—ãŸHTMLã‚’DOMã«åæ˜ 
    container.innerHTML = h;
}
    // --- ãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºæ©Ÿèƒ½ ---
    function toggleCharSelection(id) {
        if(appState.characters[id]) {
            appState.characters[id].isSelected = !appState.characters[id].isSelected;
            saveData();
        }
    }

    function toggleAllCharSelection() {
        const allChars = Object.values(appState.characters);
        const hasUnselected = allChars.some(c => !c.isSelected);
        // æœªé¸æŠãŒä¸€ã¤ã§ã‚‚ã‚ã‚Œã°å…¨é¸æŠã€ã™ã¹ã¦é¸æŠæ¸ˆã¿ãªã‚‰å…¨è§£é™¤
        allChars.forEach(c => c.isSelected = hasUnselected);
        saveData();
        renderCurrentCharacterSheet();
    }

    function pickRandomChar() {
        const candidates = Object.values(appState.characters).filter(c => c.isSelected);
        if (candidates.length === 0) {
            alert("ãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const winner = candidates[Math.floor(Math.random() * candidates.length)];
        const names = candidates.map(c => c.name).join(', ');
        addLogEntry('system', 'ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º', `å€™è£œ: ${names}\nå½“é¸:  ${winner.name} `);
        showToast(`ğŸ² ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º\nå½“é¸: ${winner.name}`);
    }

    // ã‚«ã‚¹ã‚¿ãƒ é …ç›®è¿½åŠ ç”¨é–¢æ•°
    function addCustomResourceTo(id) {
        appState.characters[id].customResources.push({ name: "æ–°é …ç›®", current: 0, max: 0 });
        renderCurrentCharacterSheet();
        saveData();
    }

    // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ“ä½œé–¢æ•° ---
    function setActiveCharacter(id) {
        if (appState.currentCharacterId !== id) {
            // åˆ¥ã®ã‚­ãƒ£ãƒ©ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¦é–‹ã
            appState.currentCharacterId = id;
            appState.characters[id].isExpanded = true;
        } else {
            // æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ©ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆï¼šé–‹é–‰ãƒˆã‚°ãƒ«
            appState.characters[id].isExpanded = !appState.characters[id].isExpanded;
        }
        saveData();
        renderCurrentCharacterSheet();
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ ---

    function handleDragStart(e, id) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', id);
        // ãƒ‰ãƒ©ãƒƒã‚°ç”»åƒã®è¨­å®šãªã©ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹
    }

    function handleDragEnd(e) {
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªã‚‰ã“ã“ã«è¨˜è¿°
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const target = e.currentTarget; // detailsè¦ç´ 
        const rect = target.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        
        // ä¸ŠåŠåˆ†ãªã‚‰ä¸Šã«æŒ¿å…¥ã€ä¸‹åŠåˆ†ãªã‚‰ä¸‹ã«æŒ¿å…¥ã®ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
        target.classList.remove('drop-top', 'drop-bottom');
        if (offsetY < rect.height / 2) {
            target.classList.add('drop-top');
        } else {
            target.classList.add('drop-bottom');
        }
    }

    function handleDragLeave(e) { 
        e.currentTarget.classList.remove('drop-top', 'drop-bottom'); 
    }

    function handleDrop(e, destId) {
        if (e.stopPropagation) e.stopPropagation();
        
        const target = e.currentTarget;
        const isTop = target.classList.contains('drop-top');
        target.classList.remove('drop-top', 'drop-bottom');
        
        const srcId = e.dataTransfer.getData('text/plain');
        if (srcId && srcId !== destId) {
            reorderCharacters(srcId, destId, isTop ? 'before' : 'after');
        }
        return false;
    }

    function reorderCharacters(srcId, destId, position) {
        const order = appState.characterOrder;
        const srcIdx = order.indexOf(srcId);
        let destIdx = order.indexOf(destId);
        
        if (srcIdx < 0 || destIdx < 0) return;
        
        // ç§»å‹•å…ƒã‚’å‰Šé™¤
        order.splice(srcIdx, 1);
        
        // å‰Šé™¤ã«ã‚ˆã£ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãšã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å†å–å¾—
        destIdx = order.indexOf(destId);
        
        // æŒ¿å…¥ä½ç½®ã®èª¿æ•´
        if (position === 'after') {
            destIdx++;
        }
        
        order.splice(destIdx, 0, srcId);
        
        saveData();
        renderCurrentCharacterSheet();
    }

    // ã‚­ãƒ£ãƒ©å‰Šé™¤ç”¨é–¢æ•°ï¼ˆVer 1.1æº–æ‹ ï¼‰
    function deleteCharacter(id) {
        if (Object.keys(appState.characters).length <= 1) {
            alert("æœ€å¾Œã®1äººã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
            return;
        }
        delete appState.characters[id];
        // é †åºé…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
        if (appState.characterOrder) {
            appState.characterOrder = appState.characterOrder.filter(cid => cid !== id);
        }
        appState.currentCharacterId = Object.keys(appState.characters)[0];
        renderCurrentCharacterSheet();
        saveData();
    }

    // ------------------------
    // --- Dice & Logs ---
    // ------------------------
    // ä»˜è¿‘ã® handleActionRoll ã‚’ä¿®æ­£
    // ç¬¬4å¼•æ•°ã« manualTotal ã‚’è¿½åŠ ã—ã€ã“ã‚ŒãŒã‚ã‚‹å ´åˆã¯è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å³å®Ÿè¡Œã—ã¾ã™
    function handleActionRoll(id, type, mode = 'skill', manualTotal = null) {
        // â˜…ä¿®æ­£ç‚¹: è¨ˆç®—æ¸ˆã¿ã®å€¤(manualTotal)ãŒæ¸¡ã•ã‚ŒãŸã‚‰ã€ãã‚Œã‚’ãã®ã¾ã¾ä½¿ã£ã¦çµ‚äº†
        if (manualTotal !== null) {
            // labelã®ç”Ÿæˆï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
            const label = `${type}åˆ¤å®š`;
            // executeRoll ã«ã¯ base=manualTotal, equip=0, global=0 ã§æ¸¡ã™ï¼ˆäºŒé‡åŠ ç®—é˜²æ­¢ï¼‰
            executeRoll(id, label, manualTotal, 0, 0); 
            return;
        }

        const c = appState.characters[id];
        const d = c.data;
        const globalMod = parseInt(document.getElementById('skillValue').value) || 0;
        
        let base = d.skill; 
        let equip = 0;
        let label = "";

        const abilityKeys = { 'å¹¸é‹': 'luck', 'ç­‹åŠ›': 'str', 'é­”è¡“': 'mag', 'å™¨ç”¨': 'dex' };

        if (abilityKeys[type]) {
            const key = abilityKeys[type];
            if (mode === 'ability') {
                base = (d.subAbility && d.subAbility.type === key) ? d.subAbility.current : 0;
                label = `${type}åˆ¤å®š(èƒ½åŠ›å€¤)`;
            } else {
                base = d.skill;
                label = `${type}åˆ¤å®š(æŠ€é‡)`;
            }
            equip = d.abilityMods[key] || 0;
        } else if (type === 'ç”Ÿå‘½') { 
            base = (d.life && d.life.type === 'hp') ? d.life.current : 1; 
            equip = d.lifeMod || 0;
            label = "ç”Ÿå‘½åŠ›åˆ¤å®š";
        } else {
            // æˆ¦é—˜ãƒ»ç‰¹æ®Šåˆ¤å®š (æ¥è¿‘, é è·é›¢, é˜²å¾¡, å¯¾é­”æ³•)
            let actionMod = 0;
            let actionLabel = type;

            if (type === 'æ¥è¿‘') { actionMod = d.meleeMod || 0; actionLabel = "æ¥è¿‘æ”»æ’ƒ"; }
            else if (type === 'é è·é›¢') { actionMod = d.rangedMod || 0; actionLabel = "é è·é›¢æ”»æ’ƒ"; }
            else if (type === 'é˜²å¾¡') { actionMod = d.armorMod || 0; actionLabel = "é˜²å¾¡åˆ¤å®š"; }
            else if (type === 'å¯¾é­”æ³•') { actionMod = d.magicResistMod || 0; actionLabel = "å¯¾é­”æ³•åˆ¤å®š"; }

            if (mode === 'ability') {
                base = d.subAbility.current || 0;
                // è£…å‚™/ã‚¹ã‚­ãƒ« = ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¿®æ­£ + èƒ½åŠ›ä¿®æ­£
                const currentType = d.subAbility.type;
                const abilityMod = d.abilityMods[currentType] || 0;
                equip = actionMod + abilityMod;
                label = `${actionLabel}(${d.subAbility.label})`;
            } else {
                base = d.skill;
                equip = actionMod;
                label = `${actionLabel}(æŠ€é‡)`;
            }
        }

        executeRoll(id, label, base, equip, globalMod);
    }
    //â‘¡ handleRlhRollï¼ˆRLHå°‚ç”¨ã®åˆ¤å®šè¨ˆç®—ï¼‰
    // æ–°ãƒ»çµ±åˆãƒ­ãƒ¼ãƒ«å®Ÿè¡Œé–¢æ•°ï¼ˆä»¥å‰ã®ãƒ­ã‚°å½¢å¼ã‚’å®Œå…¨å†ç¾ï¼‰
    function executeRoll(id, label, base, equip, globalMod) {
        const c = appState.characters[id];
        const n = parseInt(document.getElementById('rollCount').value) || 1;
        const tg = parseInt(document.getElementById('targetValue').value) || 0; // ç›®æ¨™å€¤
        const sk = base + equip + globalMod; // åˆè¨ˆä¿®æ­£å€¤
    
        let s=0, f=0, cr=0, fum=0, details=[];
    
        for(let i=0; i<n; i++){
            const r = Math.floor(Math.random()*6)+1;
            const tot = r + sk;
        
        // RLHåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: 6ãŒã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€1ãŒãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼ˆé€†ã®å ´åˆã¯ã“ã“ã‚’å…¥ã‚Œæ›¿ãˆã¦ãã ã•ã„ï¼‰
        // â€»ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ãŒ r===6 ã§ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã ã£ãŸã®ã§ã€ãã‚Œã«åˆã‚ã›ã¾ã™
            let resText = "";
            if(r === 6) {
                resText = "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«";
                s++; cr++;
            } 
            else if(r === 1) {
                resText = "ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«";
                f++; fum++;
            }
            else if(tot >= tg) {
                resText = "æˆåŠŸ";
                s++;
            }
            else {
                resText = "å¤±æ•—";
                f++;
            }
            details.push(`#${i+1}: 1D6(${r})+${sk}=${tot} -> ${resText}`);
        }

        // ãƒ­ã‚°å‡ºåŠ›
        addLogEntry('dice', `${label}åˆ¤å®š`, 
        `[${c.name}] ä½¿ç”¨æ•°å€¤: ${label}(${base}) + è£…å‚™/ã‚¹ã‚­ãƒ«(${equip}) + ä¿®æ­£(${globalMod}) = è¨ˆ+${sk}\n` +
        `${n}RLH >= ${tg}\n` +
        `${details.join('\n')}\n` +
        `æˆåŠŸ:${s} å¤±æ•—:${f} (C:${cr}/F:${fum})`
        );
    }

    //handleLocalRollï¼ˆãã®ä»–å¸†ãƒ­ãƒ¼ãƒ«ã®åˆ¤å®šè¨ˆç®—ï¼‰
    function handleLocalRoll(cmd, label) {
        const c = appState.characters[appState.currentCharacterId];
        // ä¿®æ­£å€¤ï¼ˆquickModValueï¼‰ã‚’å–å¾—
        const mod = parseInt(document.getElementById('quickModValue').value) || 0;
        let res = "";
        if(cmd==='1D3') { 
            const r = Math.floor(Math.random()*3)+1; 
            res = `1D3(${r})+${mod}=${r+mod}`; 
        }
        else if(cmd==='1D6') { 
            const r = Math.floor(Math.random()*6)+1; 
            res = `1D6(${r})+${mod}=${r+mod}`; 
        }
        else if(cmd==='D33') {
            const r1 = Math.floor(Math.random()*3)+1;
            const r2 = Math.floor(Math.random()*3)+1;
            res = `D33[${r1},${r2}](${r1*10+r2})+${mod}=${(r1*10+r2)+mod}`;
        }
        else if(cmd==='D66') { 
            const r1=Math.floor(Math.random()*6)+1, r2=Math.floor(Math.random()*6)+1; 
            res=`D66[${r1},${r2}](${r1*10+r2})+${mod}=${(r1*10+r2)+mod}`; 
        }
        else if(cmd==='Treasure'){
            const r = Math.floor(Math.random()*6)+1;
            const total = r + mod; // ãƒ€ã‚¤ã‚¹ç›®ï¼‹ä¿®æ­£å€¤ã®åˆè¨ˆ
            let detail = "";
            let isCsvData = false;

            // --- 1. CSV(scenarioMaster) ã‹ã‚‰åˆè¨ˆå€¤(total)ã§æ¤œç´¢ ---
            const csvEntry = scenarioMaster.find(s => s.type === 'treasure' && s.id === total.toString());

            if (csvEntry) {// ã€CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ãŸå ´åˆã€‘
                detail = csvEntry.text;
                isCsvData = true;
            } 
            else {// ã€CSVã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã€‘é»„æ˜ã®é¨å£«æº–æ‹ 
                if (total <= 1) {
                        detail = "é‡‘è²¨1æš";
                } 
                else if (total === 2) {
                    const d = Math.floor(Math.random()*6)+1;
                    detail = `1D6(${d})æšã®é‡‘è²¨`;
                } 
                else if (total === 3) {
                    const d1 = Math.floor(Math.random()*6)+1;
                    const d2 = Math.floor(Math.random()*6)+1;
                    let sum = d1 + d2;
                    let lowLimit = "";
                    if (sum < 5) { sum = 5; lowLimit = "(ä¸‹é™5æšé©ç”¨)"; }
                    detail = `2D6[${d1},${d2}](${d1+d2}) -> ${sum}æšã®é‡‘è²¨ ${lowLimit}`;
                } 
                else if (total === 4) {
                    const a1 = Math.floor(Math.random()*6)+1;
                    const a2 = Math.floor(Math.random()*6)+1;
                    detail = `ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼1å€‹ (ä¾¡å€¤: 1D6[${a1}]Ã—1D6[${a2}] = ${a1*a2}æšã®é‡‘è²¨)`;
                }
                else if (total === 5) {
                    const d = Math.floor(Math.random()*6)+1;
                    let value = d * 5;
                    let lowLimit = "";
                    if (value < 15) { value = 15; lowLimit = "(ä¸‹é™15æšé©ç”¨)"; }
                    detail = `å®çŸ³ãƒ»å°1å€‹ (ä¾¡å€¤: 1D6(${d})Ã—5 = ${d*5} -> ${value}æšã®é‡‘è²¨ ${lowLimit})`;
                } 
                else if (total === 6) {
                    const d1 = Math.floor(Math.random()*6)+1;
                    const d2 = Math.floor(Math.random()*6)+1;
                    let value = (d1 + d2) * 5;
                    let lowLimit = "";
                    if (value < 30) { value = 30; lowLimit = "(ä¸‹é™30æšé©ç”¨)"; }
                    detail = `å®çŸ³ãƒ»å¤§1å€‹ (ä¾¡å€¤: 2D6[${d1},${d2}](${d1+d2})Ã—5 = ${(d1+d2)*5} -> ${value}æšã®é‡‘è²¨ ${lowLimit})`;
                } 
                else {detail = "â˜…â˜…â˜… é­”æ³•ã®å®ç‰©è¡¨ã‚’ãƒ­ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ â˜…â˜…â˜…";}
            }

            // ãƒ­ã‚°ã«ã€Œä¿®æ­£å€¤è¾¼ã¿ã®åˆè¨ˆã€ã¨ã€Œå…ƒã®ãƒ€ã‚¤ã‚¹ç›®ã€ã‚’æ˜è¨˜ã™ã‚‹
            const modText = mod !== 0 ? `(${r}${mod >= 0 ? '+' : ''}${mod})` : "";
            res = `å®ç‰©çµæœï¼š${total}${modText}\nå†…å®¹ï¼š${detail}`;
            addLogEntry('dice', label, `[å®Ÿè¡Œè€…: ${c.name}]\n${res}`);
            return;
        }

        // Treasureä»¥å¤–ã®ãƒ€ã‚¤ã‚¹ï¼ˆ1D6ãªã©ï¼‰ã®ãƒ­ã‚°å‡ºåŠ›
        addLogEntry('dice', label, `[å®Ÿè¡Œè€…: ${c.name}]\n${res}`);
    }

    function addLogEntry(type, title='', content='') {
        const e = { type, content: type==='dice'?`ã€${title}ã€‘\n${content}`:content, time: new Date().toLocaleTimeString() };
        if(type==='input') { const i=document.getElementById('logInput'); if(!i.value.trim()) return; e.content=i.value; i.value=''; }
        appState.logEntries.push(e); renderLogArea(); saveData();

        // ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«æ™‚ã¯ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’å‡ºã™ï¼ˆã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆé–²è¦§ä¸­ãªã©ã«ä¾¿åˆ©ï¼‰
        if (appState.showToastNotifications !== false && type === 'dice') {
            // çµæœè¡Œã ã‘ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤ºï¼ˆé•·ããªã‚Šã™ããªã„ã‚ˆã†ã«ï¼‰
            const lines = content.split('\n');
            // "->" ã‚’å«ã‚€è¡Œï¼ˆåˆ¤å®šçµæœï¼‰ã‚„ "å®ç‰©" é–¢é€£ã€å˜ç´”ãªãƒ€ã‚¤ã‚¹ç›®ãªã©ã‚’æŠ½å‡º
            const resultLines = lines.filter(l => l.includes('->') || l.includes('å®ç‰©') || l.includes('å†…å®¹ï¼š') || l.includes('1D') || l.includes('D66') || l.includes('D33') || l.includes('æˆåŠŸ:'));
            const displayContent = resultLines.length > 0 ? resultLines.join('\n') : content;
            showToast(`ğŸ² ${title}\n${displayContent}`);
        }
    }

    //log
    function renderLogArea() {
        const a = document.getElementById('logArea');
        a.innerHTML = appState.logEntries.map((e, idx) => {
                if(e.type==='separator') return `<div class="border-t-2 border-purple-200 my-4 relative group"><button onclick="deleteLog(${idx})" class="absolute -top-3 right-0 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] hidden group-hover:block">Ã—</button></div>`;
                return `<div class="p-2 border rounded text-xs relative group ${e.type==='dice'?'bg-indigo-50':e.type==='system'?'bg-gray-100':'bg-white'}">
                    <div class="flex justify-between text-[9px] text-gray-400"><span>${e.time}</span><div class="opacity-0 group-hover:opacity-100"><button onclick="editLog(${idx})">âœ</button> <button onclick="deleteLog(${idx})">Ã—</button></div></div>
                    <div class="whitespace-pre-wrap">${e.content}</div></div>`;
        }).join('');
        a.scrollTop = a.scrollHeight;
    }

    function deleteLog(i){ appState.logEntries.splice(i,1); renderLogArea(); saveData(); }
    function editLog(i){ const n=prompt("ç·¨é›†",appState.logEntries[i].content); if(n!==null){appState.logEntries[i].content=n; renderLogArea(); saveData();}}
    function deleteChar() { if(Object.keys(appState.characters).length > 1 && confirm("å‰Šé™¤ï¼Ÿ")){ delete appState.characters[appState.currentCharacterId]; appState.currentCharacterId = Object.keys(appState.characters)[0]; renderAll(); saveData(); }}        function switchCharacter(id) { appState.currentCharacterId = id; renderCurrentCharacterSheet(); }
    function renderCharacterSelector() { document.getElementById('charSelector').innerHTML = Object.entries(appState.characters).map(([id,c])=>`<option value="${id}" ${id===appState.currentCharacterId?'selected':''}>${c.name}</option>`).join(''); }
    function renderAll() { 
        document.getElementById('logTitle').value = appState.logTitle; 
        renderD66Grid(); renderD66Table(); renderLogArea();  renderCurrentCharacterSheet(); 
    }
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ã®ä¿å­˜
    function downloadData() {
        const title = document.getElementById('logTitle').value || "session";
        const blob = new Blob([JSON.stringify(appState, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    // ãƒ­ã‚°ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ä¿å­˜
    function exportLogText() {
        const title = document.getElementById('logTitle').value || "session_log"; // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
        let t = `SESSION: ${title}\n\n`;
        appState.logEntries.forEach(e => t += `[${e.time}] ${e.content}\n`);
        const b = new Blob([t], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = `${title}.txt`; // ãƒ•ã‚¡ã‚¤ãƒ«åã«åæ˜ 
        a.click();
    }
    // è¡¨ç¤ºä¸­ã®ã‚­ãƒ£ãƒ©ã®ã¿ä¿å­˜
    function downloadCharacterById(id) {
        const c = appState.characters[id];
        if (!c) return;
        const exportData = { ...c, isSingleChar: true };
        const b = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = `Character_${c.name || 'no_name'}.json`;
        a.click();
    }

    //â‘¢ handleFileUploadï¼ˆèª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼‰
    // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆå…¨ä½“ä¿å­˜JSONã¨ã‚­ãƒ£ãƒ©å˜ä½“JSONã‚’è‡ªå‹•åˆ¤åˆ¥ï¼‰
    function handleFileUpload(e) { 
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader(); 
        r.onload = (ev) => { 
            try {
                const data = JSON.parse(ev.target.result);              
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å˜ä½“ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
                if (data.isSingleChar || (data.id && data.data)) {
                    appState.characters[data.id] = data;
                    appState.currentCharacterId = data.id;
                    alert(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${data.name}ã€ã‚’èª­ã¿è¾¼ã¿ãƒ»æ›´æ–°ã—ã¾ã—ãŸã€‚`);
                } 
                // å…¨ä½“ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
                else {
                    appState = { ...appState, ...data };
                    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
                }
                renderAll(); 
                saveData();
            }
            catch (err) { 
                alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            }
        }; 
        r.readAsText(f); 
        e.target.value = ''; 
    }
    function resetAllData(){ if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")){localStorage.removeItem(STORAGE_KEY); location.reload();}}
    document.getElementById('logInput').addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addLogEntry('input'); }});
    window.onload = loadData;
        
    // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
    function toggleHelp(show) {
        const modal = document.getElementById('helpModal');
        if (modal) {modal.style.display = show ? 'block' : 'none';}
    }

    // Toastè¡¨ç¤ºé–¢æ•°
    function showToast(text) {
        const container = document.getElementById('toast-container');
        if(!container) return;
        const el = document.createElement('div');
        el.className = 'toast-msg';
        el.textContent = text;
        
        // ã‚¯ãƒªãƒƒã‚¯ã§å³åº§ã«æ¶ˆå»
        el.onclick = () => {
            el.classList.remove('show');
            setTimeout(() => { if(el.parentNode) el.remove(); }, 300);
        };

        container.appendChild(el);
        
        requestAnimationFrame(() => { el.classList.add('show'); });
        
        setTimeout(() => {
            if(el.parentNode) el.classList.remove('show');
            setTimeout(() => { if(el.parentNode) el.remove(); }, 300);
        }, 4000); // 4ç§’å¾Œã«æ¶ˆãˆã‚‹
    }

    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
    function toggleSettings(show) {
        const modal = document.getElementById('settingsModal');
        if (modal) {
            modal.style.display = show ? 'block' : 'none';
            if (show) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã«ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
                document.getElementById('toastToggle').checked = appState.showToastNotifications !== false;
            }
        }
    }

    // ãƒ†ãƒ¼ãƒè¨­å®š
    function setTheme(themeName) {
        appState.theme = themeName;
        applyTheme(themeName);
        saveData();
    }
    function applyTheme(themeName) {
        document.body.classList.remove('theme-night', 'theme-sepia');
        if (themeName === 'night') document.body.classList.add('theme-night');
        if (themeName === 'sepia') document.body.classList.add('theme-sepia');
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®ã‚ªãƒ³ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ
    function toggleToastNotifications(isEnabled) {
        appState.showToastNotifications = isEnabled;
        saveData();
    }

    // æ–°ã—ã„ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰åˆ¶å¾¡é–¢æ•°
    function toggleCharacterAccordion(summaryElement, id) {
        const detailsElement = summaryElement.closest('details');
        if (!detailsElement) return;

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãŒæ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã€é–‰ã˜ã‚‹
        if (detailsElement.open) {
            detailsElement.open = false;
            appState.currentCharacterId = null; // é–‰ã˜ãŸã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è§£é™¤
        } else {
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã
            detailsElement.open = true;
            appState.currentCharacterId = id; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¨­å®š

            // ä»–ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('#current-character-sheet details').forEach(otherDetails => {
                if (otherDetails !== detailsElement && otherDetails.open) {
                    otherDetails.open = false;
                }
            });
        }
        saveData(); // currentCharacterId ã®å¤‰æ›´ã‚’ä¿å­˜
    }
</script>

<div id="helpModal" class="modal" onclick="toggleHelp(false)">
    <div class="modal-content custom-scroll" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center border-b pb-2 mb-4">
            <h2 class="text-xl font-bold text-gray-800">RLH Companion ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <button onclick="toggleHelp(false)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="text-sm text-gray-700 space-y-5 leading-relaxed">
            
            <section class="bg-gray-50 p-3 rounded border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨è¨˜</h3>
                <p class="text-[11px]">ä½œè€…ï¼šæˆç”°ç ‚ç”·</p>
                <p class="text-[11px]">ã“ã‚Œã¯FTæ›¸æˆ¿ã«ã‚ˆã‚‹ä¸€äººç”¨TRPGã€Œãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ãƒãƒ¼ãƒ•ã€ã‚’å¿«é©ã«éŠã¶ãŸã‚ã®ã€éå…¬å¼ã€‘ãƒ—ãƒ¬ã‚¤è£œåŠ©ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¬å¼åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã¯ã€BOOTHã«ã¦PDFã‚’ç„¡æ–™é…å¸ƒã—ã¦ã„ã¾ã™ã€‚</p>
                <div class="mt-2 text-[11px] space-y-1">
                    <p>é ’å¸ƒå…ƒ: <a href="https://ftbooks.booth.pm/items/4671946" target="_blank" class="text-blue-600 underline">BOOTH å•†å“ãƒšãƒ¼ã‚¸</a></p>
                    <p>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ­ã‚´: <a href="https://ftbooks.xyz/ftnews/article/RLH-100.jpg" target="_blank" class="text-blue-600 underline">RLH-100.jpg</a></p>
                </div>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">1. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</h3>
                <p>ç”»é¢å³å´ã®ã€Œã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã€ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>è¿½åŠ :</b> ä¸‹éƒ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ã€Œä¸»äººå…¬ã€ã€Œå…µå£«ã€ãªã©ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§è¿½åŠ ã§ãã¾ã™ã€‚</li>
                    <li><b>ç·¨é›†:</b> ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’é–‹é–‰ã§ãã¾ã™ã€‚åå‰ã‚„æ•°å€¤ã¯ç›´æ¥ç·¨é›†å¯èƒ½ã§ã™ã€‚</li>
                    <li><b>ä¸¦ã³æ›¿ãˆ:</b> ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã®å³ç«¯ã«ã‚ã‚‹ãƒãƒ³ãƒ‰ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
                    <li><b>ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º:</b> ã€Œãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºå¯¾è±¡ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€ä¸Šéƒ¨ã®ã€ŒğŸ² ãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å¯¾è±¡è€…ã‹ã‚‰1åã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã—ã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">2. åˆ¤å®šã¨ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«</h3>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>æ±ç”¨ãƒ€ã‚¤ã‚¹:</b> ç”»é¢ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ï¼ˆ1D6, D66, å®ç‰©ãªã©ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å·¦ã®ã€Œä¿®æ­£ã€å€¤ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚</li>
                    <li><b>ã‚­ãƒ£ãƒ©åˆ¥åˆ¤å®š:</b> ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆå†…ã®å„é …ç›®ã«ã‚ã‚‹ãƒœã‚¿ãƒ³ã§åˆ¤å®šã§ãã¾ã™ã€‚
                        <ul class="list-circle ml-4 text-[11px] text-gray-600">
                            <li><b>æŠ€:</b> æŠ€é‡ç‚¹ï¼‹ä¿®æ­£å€¤ã§åˆ¤å®šã€‚</li>
                            <li><b>èƒ½:</b> ãã®é …ç›®ã®èƒ½åŠ›å€¤ï¼ˆç­‹åŠ›ãªã©ï¼‰ï¼‹ä¿®æ­£å€¤ã§åˆ¤å®šã€‚</li>
                            <li><b>Roll:</b> æˆ¦é—˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¥è¿‘ãƒ»é˜²å¾¡ãªã©ï¼‰ã®ä¿®æ­£å€¤ã‚’åŠ å‘³ã—ã¦åˆ¤å®šã€‚</li>
                        </ul>
                    </li>
                    <li><b>ä¿®æ­£å€¤:</b> ç”»é¢ä¸Šéƒ¨ã®ã€Œä¿®æ­£å€¤ã€ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã¯ã€ã™ã¹ã¦ã®åˆ¤å®šã«åŠ ç®—ã•ã‚Œã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">3. ã‚·ãƒŠãƒªã‚ªé€²è¡Œ (D66 GRID)</h3>
                <p>ä¸­å¤®ã®GRIDã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>GRIDå…¥åŠ›:</b> ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¹ãŒç‚¹ç¯ã—ã€é€²è¡Œåº¦ï¼ˆ1ã€œ3å›ç›®ï¼‰ã«å¿œã˜ã¦è‰²åˆ†ã‘ã•ã‚Œã¾ã™ã€‚</li>
                    <li><b>CSVé€£æº:</b> ã€ŒCSVèª­è¾¼ã€ã‹ã‚‰ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¨ã€å‡ºç›®ã«å¯¾å¿œã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆãŒãƒ­ã‚°ã«è‡ªå‹•å‡ºåŠ›ã•ã‚Œã€é¸æŠè‚¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">4. ä¿å­˜ãƒ»è¨­å®š</h3>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>ä¿å­˜/èª­è¾¼:</b> ã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ã®ä¿å­˜ï¼ˆJSONï¼‰ã€ãƒ­ã‚°ã®ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ï¼ˆtxtï¼‰ãŒå¯èƒ½ã§ã™ã€‚ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆå€‹åˆ¥ã®ä¿å­˜ã‚‚å¯èƒ½ã§ã™ã€‚</li>
                    <li><b>è¨­å®š(âš™ï¸):</b> ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã€ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒï¼ˆãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã€ã‚»ãƒ”ã‚¢ãªã©ï¼‰ã®å¤‰æ›´ã‚„ã€ãƒ€ã‚¤ã‚¹çµæœã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é€šçŸ¥ã®ON/OFFãŒåˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
                </ul>
            </section>

            <section class="text-[11px] text-gray-500 pt-2 border-t">
                <p><b>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</b> 2.0</p>
                <p><b>è©³ç´°(note)ï¼š</b> https://note.com/sandman_sunao/n/ndaeb94b048f3?sub_rt=share_sb</p>
            </section>

        </div>
        <button onclick="toggleHelp(false)" class="mt-6 w-full bg-gray-800 text-white py-2 rounded-lg font-bold">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="settingsModal" class="modal" onclick="toggleSettings(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">è¨­å®š</h2>
        <div class="mb-6">
            <h3 class="font-bold mb-2 text-sm text-gray-700">ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒ</h3>
            <div class="flex gap-2">
                <button onclick="setTheme('colorful')" class="flex-1 py-3 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-50 text-xs font-bold text-gray-800">ğŸŒˆ ã‚«ãƒ©ãƒ•ãƒ«</button>
                <button onclick="setTheme('night')" class="flex-1 py-3 bg-gray-800 text-white border border-gray-600 rounded shadow-sm hover:bg-gray-700 text-xs font-bold">ğŸŒ™ ãƒŠã‚¤ãƒˆ</button>
                <button onclick="setTheme('sepia')" class="flex-1 py-3 bg-[#f4e4bc] text-[#433422] border border-[#d4c5b0] rounded shadow-sm hover:bg-[#e8d5a5] text-xs font-bold">ğŸ“œ ã‚»ãƒ”ã‚¢</button>
            </div>
        </div>
        <div class="mb-6">
            <h3 class="font-bold mb-2 text-sm text-gray-700">é€šçŸ¥è¨­å®š</h3>
            <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100">
                <input type="checkbox" id="toastToggle" onchange="toggleToastNotifications(this.checked)" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-800">ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«çµæœã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã™ã‚‹</span>
            </label>
        </div>
        <button onclick="toggleSettings(false)" class="w-full bg-gray-600 text-white py-2 rounded-lg font-bold shadow hover:bg-gray-700">é–‰ã˜ã‚‹</button>
    </div>
</div>
</body>
</html>