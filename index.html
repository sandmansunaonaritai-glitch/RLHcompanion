<!--RLHcompanion_Ver1.0-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLH Companion - Ultimate Integrated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        
        /* D66 Grid Styles */
        .d66-grid-container { width: 100%; display: grid; grid-template-columns: repeat(6, 1fr); border: 1px solid #14b8a6; max-width: 180px; }
        .d66-grid-cell { aspect-ratio: 1.1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; border: 1px solid #e5e7eb; position: relative; background: #fff; }
        
        /* å›æ•°ã”ã¨ã®èƒŒæ™¯è‰² */
        .cell-row-0 { background-color: #ccfbf1 !important; border-color: #2dd4bf; } /* 1å›ç›®ï¼šã‚¿ãƒ¼ã‚³ã‚¤ã‚º */
        .cell-row-1 { background-color: #fef3c7 !important; border-color: #fbbf24; } /* 2å›ç›®ï¼šã‚¢ãƒ³ãƒãƒ¼ */
        .cell-row-2 { background-color: #ffe4e6 !important; border-color: #fb7185; } /* 3å›ç›®ï¼šãƒ­ãƒ¼ã‚º */
        .d66-order-tag { position: absolute; font-size: 0.5rem; color: #374151; font-weight: 900; }

        /* Record Table */
        .record-table { border-collapse: collapse; font-size: 10px; width: 100%; table-layout: fixed; }
        .record-table th, .record-table td { border: 1px solid #ccc; text-align: center; padding: 2px 0; height: 22px; }
        .record-table th { background: #f9fafb; color: #667085; }
        .record-table tr.active-row { background: #fffbeb; outline: 2px solid #f59e0b; outline-offset: -2px; }
        .resource-input { padding: 0.1rem; font-size: 0.85rem; text-align: center; border-radius: 0.25rem; width: 2.8rem; border: 1px solid #d1d5db; }

        /* Mobile Tab View */
        @media (max-width: 1023px) {
            .view-tab { display: none; }
            .view-tab.active { display: flex; flex-direction: column; }
            .tab-btn.active { background-color: #374151; color: white; border-bottom: 2px solid #6366f1; }
        }
       /* ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
       .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
       .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <input type="file" id="uploadFile" accept=".json" class="hidden" onchange="handleFileUpload(event)">
    <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleCsvUpload(event)">

    <header class="bg-gray-800 text-white shadow-xl z-10 shrink-0">
        <div class="p-2 px-4 flex flex-wrap items-center gap-4 border-b border-gray-700">
            <h1 class="text-lg font-bold shrink-0 flex items-center">ğŸ² RLH Companion
            <button onclick="toggleHelp(true)" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm">?</button>
</h1>
            <div class="flex items-center bg-gray-900 rounded-lg p-1 space-x-2 flex-grow max-w-3xl">
                <input type="text" id="logTitle" placeholder="ã‚»ãƒƒã‚·ãƒ§ãƒ³å" class="bg-transparent border-none focus:ring-0 text-sm font-semibold px-2 flex-grow">
                <button onclick="document.getElementById('uploadFile').click()" class="bg-green-700 hover:bg-green-600 text-[10px] py-1 px-2 rounded">èª­è¾¼</button>
                <button onclick="downloadData()" class="bg-blue-700 hover:bg-blue-600 text-[10px] py-1 px-2 rounded">å…¨ä½“ä¿å­˜</button>
                <button onclick="exportLogText()" class="bg-teal-600 hover:bg-teal-500 text-[10px] py-1 px-2 rounded">ãƒ­ã‚°DL(txt)</button>
                <button onclick="resetAllData()" class="bg-red-700 hover:bg-red-600 text-[10px] py-1 px-2 rounded">å…¨ä½“æ¶ˆå»</button>
            </div>
        </div>
<div class="p-2 px-4 flex flex-wrap gap-4 items-center bg-gray-700 text-[11px] text-white">
    <div class="flex items-center space-x-2">
        <span>å›æ•°:</span>
        <input type="number" id="rollCount" value="1" class="w-8 rounded text-gray-900 px-1">
        <span>ä¿®æ­£å€¤:</span>
        <input type="number" id="skillValue" value="0" class="w-8 rounded text-gray-900 px-1 text-center">
        <span>ç›®æ¨™å€¤:</span>
        <input type="number" id="targetValue" value="3" class="w-8 rounded text-gray-900 px-1 text-center">
        
        <div class="flex items-center space-x-1 ml-2">
            <button onclick="handleRlhRoll('skill')" class="bg-indigo-600 hover:bg-indigo-500 px-2 py-1 rounded font-bold text-[10px] whitespace-nowrap">æŠ€é‡åˆ¤å®š</button>
            <button onclick="handleRlhRoll('sub')" class="bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded font-bold text-[10px] whitespace-nowrap">èƒ½åŠ›åˆ¤å®š</button>
        </div>
    </div>

    <div class="flex items-center space-x-1 border-l border-gray-600 pl-4">
        <span>ä¿®æ­£:</span>
        <input type="number" id="quickModValue" value="0" class="w-8 rounded text-gray-900 px-1 mr-1">
        <button onclick="handleLocalRoll('1D3', '1D3')" class="bg-gray-600 hover:bg-gray-500 px-1.5 py-0.5 rounded">1D3</button>
        <button onclick="handleLocalRoll('1D6', '1D6')" class="bg-yellow-600 hover:bg-yellow-500 px-1.5 py-0.5 rounded">1D6</button>
        <button onclick="handleLocalRoll('D66', 'D66')" class="bg-orange-600 hover:bg-orange-500 px-1.5 py-0.5 rounded">D66</button>
        <button onclick="handleLocalRoll('D33', 'D33')" class="bg-blue-600 hover:bg-blue-500 px-1.5 py-0.5 rounded">D33</button>
        <button onclick="handleLocalRoll('Treasure', 'å®ç‰©')" class="bg-green-600 hover:bg-green-500 px-1.5 py-0.5 rounded">å®ç‰©</button>
        <button onclick="handleMagicTreasure()" class="bg-purple-600 hover:bg-purple-500 px-1.5 py-0.5 rounded">é­”æ³•ã®å®ç‰©</button>
    </div>
</div>    </header>

    <nav class="lg:hidden flex bg-gray-200 border-b border-gray-300 shrink-0">
        <button onclick="switchTab('main')" id="btn-tab-main" class="tab-btn active flex-1 py-3 text-xs font-bold">ãƒ¡ã‚¤ãƒ³/ãƒ­ã‚°</button>
        <button onclick="switchTab('char')" id="btn-tab-char" class="tab-btn flex-1 py-3 text-xs font-bold">ã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆ</button>
    </nav>

    <main class="flex-1 flex overflow-hidden relative">
        <section id="view-main" class="view-tab active w-full lg:w-2/3 flex flex-col p-4 bg-white overflow-hidden">
            <details class="mb-4 border border-teal-600 rounded-lg bg-teal-50" open>
                <summary class="p-1 font-bold text-teal-800 cursor-pointer text-[10px] bg-teal-100 rounded-t-lg flex justify-between items-center px-3">
                    <span>D66 GRID & SCENARIO</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="event.preventDefault(); document.getElementById('csvUpload').click()" class="bg-slate-600 text-white px-2 rounded">CSVèª­è¾¼</button>
                        <button onclick="event.preventDefault(); resetD66Area()" class="bg-red-600 text-white px-1.5 rounded">CLR</button>
                    </div>
                </summary>
                <div class="p-2 bg-white flex flex-col space-y-2">
                    <div class="flex space-x-1 border-b pb-2">
                   	 <button onclick="playScenario('title')" class="bg-indigo-600 text-white text-[9px] px-2 py-1 rounded">ã‚¿ã‚¤ãƒˆãƒ«</button>
   			 <button onclick="playScenario('rule')" class="bg-slate-700 text-white text-[9px] px-2 py-1 rounded">ç‰¹æ®Šãƒ«ãƒ¼ãƒ«</button>
   			 <button onclick="playScenario('linear')" class="bg-orange-600 text-white text-[9px] px-2 py-1 rounded">ä¸€æœ¬é“ãƒ¢ãƒ¼ãƒ‰</button>
 			 <button onclick="playScenario('pro')" class="bg-gray-500 text-white text-[9px] px-2 py-1 rounded">ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°</button>
    
			 <button onclick="playScenario('start')" class="bg-blue-500 text-white text-[9px] px-2 py-1 rounded">é–‹å§‹</button>
			 <button onclick="playScenario('mid')" class="bg-amber-500 text-white text-[9px] px-2 py-1 rounded">ä¸­é–“</button>
			 <button onclick="playScenario('finish')" class="bg-rose-500 text-white text-[9px] px-2 py-1 rounded">æœ€çµ‚</button>
			 <button onclick="playScenario('clear')" class="bg-emerald-500 text-white text-[9px] px-2 py-1 rounded">é”æˆ</button>

 		   <span id="csvStatus" class="text-[9px] text-gray-400 self-center ml-2 italic">CSVæœªèª­è¾¼</span>
		</div>                    
                    <div class="overflow-x-auto">
                        <table class="record-table">
                            <thead>
    <tr><th style="width: 50px;">å›æ•°</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th></tr>
</thead>
                            <tbody id="recordBody"></tbody>
                        </table>
                    </div>

                    <div class="flex items-center justify-center space-x-6">
                        <div id="d66Grid" class="d66-grid-container"></div>
                        <div class="text-[10px] text-teal-700 flex flex-col items-center">
                            <span class="font-bold" id="rowLabel">Next (1å›ç›®)</span>
                            <span id="d66NextNumber" class="text-lg font-black bg-teal-700 text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
                        </div>
                    </div>
                </div>
            </details>

            <div id="logArea" class="flex-1 overflow-y-auto custom-scroll space-y-2 p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-inner"></div>
            
            <div class="flex flex-col mt-3">
                <textarea id="logInput" placeholder="ãƒ­ã‚°å…¥åŠ› (Enterã§é€ä¿¡)" rows="2" class="w-full p-2 border border-gray-300 rounded-md text-sm resize-none focus:ring-2 focus:ring-blue-400 mb-2 shadow-sm"></textarea>
                <div class="flex space-x-2 text-xs">
                    <button onclick="addLogEntry('input')" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow">é€ä¿¡</button>
                    <button onclick="addLogEntry('separator')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">åŒºåˆ‡ã‚Šç·š</button>
                </div>
            </div>
        </section>

<section id="view-char" class="view-tab w-full lg:w-1/3 flex flex-col p-4 bg-gray-200 overflow-y-auto custom-scroll border-l border-gray-300 lg:flex">
    <div class="flex flex-col gap-2 mb-4">
        <div class="flex items-center space-x-2">
            <select id="charSelector" class="flex-grow p-1 border border-gray-300 rounded bg-white text-xs font-bold shadow-sm" onchange="switchCharacter(this.value)"></select>
            <button onclick="addCharacter()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] p-2 rounded shadow">è¿½åŠ </button>
        </div>
        
        <button onclick="downloadCharacterOnly()" class="bg-indigo-700 hover:bg-indigo-600 text-white text-[10px] py-1.5 rounded shadow font-bold">
            ğŸ–« è¡¨ç¤ºä¸­ã®ã‚­ãƒ£ãƒ©ã®ã¿ä¿å­˜
        </button>
    </div>

    <div id="current-character-sheet" class="space-y-4 bg-white p-4 rounded-lg shadow flex-1"></div>
</section>
    </main>

    <script>
        const STORAGE_KEY = 'rlh_final_integrated_v1';
        let appState = { 
            logTitle: "ã‚»ãƒƒã‚·ãƒ§ãƒ³", logEntries: [], characters: {}, currentCharacterId: null, 
            d66State: [
                { grid: Array(36).fill(0), clickOrder: 1 },
                { grid: Array(36).fill(0), clickOrder: 1 },
                { grid: Array(36).fill(0), clickOrder: 1 }
            ],
            d66Table: Array.from({ length: 3 }, () => Array(13).fill("")), activeRow: 0
        };
        let scenarioMaster = [];
        let logTimeout = null; // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼å¤‰æ•°
        // --- Core Functions ---

        function switchTab(tab) {
            document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            document.getElementById('btn-tab-' + tab).classList.add('active');
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) { 
                try { 
                    const parsed = JSON.parse(stored);
                    appState = { ...appState, ...parsed };
                } catch(e) { console.error(e); } 
            }
            if (Object.keys(appState.characters).length === 0) addCharacter('åˆæœŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼');
            if (!appState.currentCharacterId || !appState.characters[appState.currentCharacterId]) {
                appState.currentCharacterId = Object.keys(appState.characters)[0];
            }
            renderAll();
        }

       // --- 1. handleCsvUpload ã®å·®ã—æ›¿ãˆ ---
function handleCsvUpload(e) {
    const f = e.target.files[0]; 
    if (!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã€é«˜åº¦ãªãƒ‘ãƒ¼ã‚¹(parseCSV)ã«æ¸¡ã™
        processCSV(ev.target.result);
    };
    r.readAsText(f);
}

// --- 2. è¤‡é›‘ãªCSVã‚’è§£æã™ã‚‹è£œåŠ©é–¢æ•° ---
function parseCSV(text) {
    const result = [];
    let currentRow = [];
    let currentToken = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                currentToken += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            currentRow.push(currentToken.trim());
            currentToken = "";
        } else if ((char === '\r' || char === '\n') && !inQuotes) {
            if (currentToken !== "" || currentRow.length > 0) {
                currentRow.push(currentToken.trim());
                result.push(currentRow);
                currentRow = [];
                currentToken = "";
            }
            if (char === '\r' && nextChar === '\n') i++;
        } else {
            currentToken += char;
        }
    }
    if (currentToken !== "" || currentRow.length > 0) {
        currentRow.push(currentToken.trim());
        result.push(currentRow);
    }
    return result;
}

// --- 3. è§£æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ scenarioMaster ã«æ ¼ç´ã™ã‚‹å‡¦ç† ---
function processCSV(text) {
    const rows = parseCSV(text);
    if (rows.length < 2) return;

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—
    const headers = rows[0].map(h => h.trim().toLowerCase());
    
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
    scenarioMaster = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((header, index) => {
            let value = row[index] || "";
            // å‰å¾Œã®å¼•ç”¨ç¬¦ã‚’å‰Šé™¤ã—ã€å†…éƒ¨ã®äºŒé‡å¼•ç”¨ç¬¦ã‚’æˆ»ã™
            value = value.replace(/^"(.*)"$/s, '$1').replace(/""/g, '"');
            obj[header] = value;
        });
        
        // turnã‚’æ•°å€¤ã«å¤‰æ› (å¤±æ•—ã—ãŸã‚‰1ã«ã™ã‚‹)
        obj.turn = parseInt(obj.turn) || 1;
        // idã‚’æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒ
        if (obj.id) obj.id = obj.id.toString();
        return obj;
    });

    // ç”»é¢ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    const statusEl = document.getElementById('csvStatus');
    if (statusEl) {
        statusEl.textContent = "èª­è¾¼æ¸ˆ (" + scenarioMaster.length + "ä»¶)";
        statusEl.className = "text-[9px] text-teal-600 self-center ml-2 font-bold";
    }
}

function playScenario(type, id = null) {
    const r = appState.activeRow;
    const turn = r + 1;
    const targetType = type.toLowerCase();

    // --- 1. ç‰¹æ®Šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸­é–“ãƒ»æœ€çµ‚ï¼‰ã®ã‚¿ã‚¤ãƒ«è¨˜éŒ²å‡¦ç† ---
    if (targetType === 'mid' || targetType === 'finish') {
        const label = (targetType === 'mid') ? "ä¸­é–“" : "æœ€çµ‚";
        
        // ç¾åœ¨ã®è¡Œ(appState.d66Table[r])ã‹ã‚‰æœ€åˆã®ç©ºãæ ã‚’æ¢ã™
        const emptyIdx = appState.d66Table[r].indexOf("");
        if (emptyIdx !== -1) {
            appState.d66Table[r][emptyIdx] = label;
            // ç”»é¢æ›´æ–°ã¨ä¿å­˜
            renderAll(); 
            saveData();
        }
    }

    // --- 2. CSVï¼ˆscenarioMasterï¼‰ã‹ã‚‰è©²å½“ã™ã‚‹ã‚‚ã®ã‚’ã€Œã™ã¹ã¦ã€æ¤œç´¢ (.filterã‚’ä½¿ç”¨) ---
    // ã¾ãšã€Œç¾åœ¨ã®å›æ•°(turn)ã€ã§æ¤œç´¢
    let entries = scenarioMaster.filter(s => s.type === targetType && s.turn === turn && (id ? s.id === id : true));
    
    // ç¾åœ¨ã®å›æ•°ã§è¦‹ã¤ã‹ã‚‰ãšã€ã‹ã¤ã€Œå…¨å›æ•°å…±é€š(turn:1)ã€ã®è¨­å®šãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§å†æ¤œç´¢
    if (entries.length === 0 && turn !== 1) {
        entries = scenarioMaster.filter(s => s.type === targetType && s.turn === 1 && (id ? s.id === id : true));
    }

    // --- 3. ãƒ­ã‚°ã®æ—¥æœ¬èªãƒ©ãƒ™ãƒ«è¨­å®š ---
    const labels = {
        title: "ã‚¿ã‚¤ãƒˆãƒ«",
        rule: "ç‰¹æ®Šãƒ«ãƒ¼ãƒ«",
        linear: "ä¸€æœ¬é“ãƒ¢ãƒ¼ãƒ‰",
        pro: "ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°",
        start: "å†’é™ºã®ã¯ã˜ã¾ã‚Š",
        mid: "ä¸­é–“ã‚¤ãƒ™ãƒ³ãƒˆ",
        clear: "å†’é™ºã®é”æˆ",
        finish: "æœ€çµ‚ã‚¤ãƒ™ãƒ³ãƒˆ",
        magictreasure: "é­”æ³•ã®å®ç‰©"
    };

    // --- 4. ãƒ­ã‚°å‡ºåŠ›å‡¦ç† ---
    if (targetType === 'd66' && id) {
        // D66ã®å ´åˆï¼šè¤‡æ•°ãƒ’ãƒƒãƒˆã—ã¦ã„ã¦ã‚‚ã€é€šå¸¸ãƒ€ã‚¤ã‚¹ç›®ã¯1ã¤ã®ãŸã‚æœ€åˆã®1ã¤ã€ã¾ãŸã¯æœªç™»éŒ²ã‚’è¡¨ç¤º
        const text = entries.length > 0 ? `\n${entries[0].text}` : "";
        addLogEntry('system', 'RESULT', `å‡ºç›®ï¼š${id}${text}`);
    } else {
        // ãã‚Œä»¥å¤–ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ«ãƒ¼ãƒ«ã€ãƒ—ãƒ­ç­‰ï¼‰ï¼š
        const labelName = labels[targetType] || type.toUpperCase();
        
        // è¤‡æ•°ãƒ’ãƒƒãƒˆã—ãŸã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ”¹è¡Œã§ã¤ãªã’ã‚‹
        const combinedText = entries.length > 0 
            ? entries.map(e => `\n${e.text}`).join('') 
            : "";
            
        addLogEntry('system', 'SCENARIO', `ã€${labelName}ã€‘${combinedText}`);
    }

    // --- 5. æœ€å¾Œã«å…¨ä½“ã‚’å†æç”»ã—ã¦ä¿å­˜ ---
    renderAll();
    saveData();
}

        // --- é­”æ³•ã®å®ç‰©ï¼ˆCSVæœªç™»éŒ²æ™‚ã¯1D6ã‚’æŒ¯ã‚‹ï¼‰ ---
function handleMagicTreasure() {
    const c = appState.characters[appState.currentCharacterId];
    const name = c ? c.name : "ï¼Ÿ";
    const turn = appState.activeRow + 1;

    // ä»Šã®å›æ•°ã¾ãŸã¯1å›ç›®ã«ã‚ã‚‹ magictreasure ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const entries = scenarioMaster.filter(s => s.type === 'magictreasure' && (s.turn === turn || s.turn === 1));
    
    let diceRange = 6; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1D6

    if (entries.length > 0) {
        // CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼šIDã®æœ€å¤§å€¤ã‚’è¦‹ã¦D3ã‹D6ã‹åˆ¤åˆ¥
        const maxId = Math.max(...entries.map(s => parseInt(s.id) || 0));
        diceRange = (maxId > 3) ? 6 : 3;
    } else {
        // CSVã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼šãã®ã¾ã¾1D6
        diceRange = 6;
    }

    const roll = Math.floor(Math.random() * diceRange) + 1;

    addLogEntry('dice', 'é­”æ³•ã®å®ç‰©', `[å®Ÿè¡Œè€…: ${name}] 1D${diceRange}(${roll})`);

    // CSVãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ playScenario ã‚’å‘¼ã³å‡ºã™
    if (entries.length > 0) {
        playScenario('magictreasure', roll.toString());
    } 
}
        // --- D66 Grid logic ---

        function renderD66Grid() {
            const gridEl = document.getElementById('d66Grid');
            gridEl.innerHTML = Array(36).fill(0).map((_, i) => {
                let cls = "d66-grid-cell", tags = "";
                appState.d66State.forEach((state, rIdx) => {
                    if (state.grid[i] > 0) {
                        cls += ` cell-row-${rIdx}`;
                        tags += `<span class="d66-order-tag" style="top:${rIdx*5}px; right:1px;">${state.grid[i]}</span>`;
                    }
                });
                return `<div class="${cls}" onclick="hD66(${i})"><span>${Math.floor(i/6)+1}${i%6+1}</span>${tags}</div>`;
            }).join('');
            document.getElementById('d66NextNumber').textContent = appState.d66State[appState.activeRow].clickOrder;
            document.getElementById('rowLabel').textContent = `Next (${appState.activeRow + 1}å›ç›®)`;
        }

        function hD66(i) {
            const r = appState.activeRow;
            const val = `${Math.floor(i/6)+1}${(i%6)+1}`;
            // åŒã˜è¡Œã®ä¸­ã§ã®ã¿ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
            if (appState.d66State[r].grid[i] > 0) {
                const order = appState.d66State[r].grid[i];
                appState.d66State[r].grid[i] = 0;
                appState.d66State[r].grid = appState.d66State[r].grid.map(v => v > order ? v-1 : v);
                appState.d66State[r].clickOrder--;
                appState.d66Table[r] = appState.d66Table[r].map(c => c === val ? "" : c);
            } else {
                appState.d66State[r].grid[i] = appState.d66State[r].clickOrder++;
                const emptyIdx = appState.d66Table[r].indexOf("");
                if (emptyIdx !== -1) appState.d66Table[r][emptyIdx] = val;
                playScenario('d66', val);
            }
            renderAll(); saveData();
        }

        function renderD66Table() {
            const body = document.getElementById('recordBody');
            body.innerHTML = appState.d66Table.map((row, rIdx) => `
                <tr class="${appState.activeRow === rIdx ? 'active-row' : ''}">
                    <td class="bg-gray-100 font-bold"><input type="radio" name="rowSel" ${appState.activeRow === rIdx ? 'checked' : ''} onchange="appState.activeRow=${rIdx}; renderAll(); saveData();"> ${rIdx+1}</td>
                    ${row.map((cell, cIdx) => `<td onclick="clearTableCell(${rIdx},${cIdx})" class="cursor-pointer">${cell}</td>`).join('')}
                </tr>`).join('');
        }

        function clearTableCell(r, c) {
            const val = appState.d66Table[r][c];
            if (val && !isNaN(val)) {
                const i = (parseInt(val[0])-1)*6 + (parseInt(val[1])-1);
                const order = appState.d66State[r].grid[i];
                appState.d66State[r].grid[i] = 0;
                appState.d66State[r].grid = appState.d66State[r].grid.map(v => v > order ? v-1 : v);
                appState.d66State[r].clickOrder--;
            }
            appState.d66Table[r][c] = ""; renderAll(); saveData();
        }



        function resetD66Area() {
            if(confirm("D66ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                appState.d66State = appState.d66State.map(() => ({ grid: Array(36).fill(0), clickOrder: 1 }));
                appState.d66Table = [Array(13).fill(""), Array(13).fill(""), Array(13).fill("")];
                renderAll(); saveData();
            }
        }

        // --- Resource & Character Logic ---

        function addCharacter(name='æ–°è¦ã‚­ãƒ£ãƒ©') {
            const id = crypto.randomUUID();
            appState.characters[id] = { id, name, deletedResources:[], 
// createNewCharacter ç­‰ã®åˆæœŸåŒ–éƒ¨åˆ†
data: {
    skill: 0,
    // life ã‚’é¸æŠå¼æ§‹é€ ã«å¤‰æ›´
    life: { type: 'hp', label: 'ç”Ÿå‘½ç‚¹', current: 10, max: 10 },
    subAbility: { type: 'luck', label: 'å¹¸é‹', current: 10, max: 10 },
    follower: { current: 0, max: 0 },
    food: 2,
    clue: 0,
    gold: 10,
    memo: ""
}};
            appState.currentCharacterId = id; renderAll(); saveData();
        }

       function onResChange(key, label, val, isMax=false) {
            const c = appState.characters[appState.currentCharacterId];
            if (!c) return;

            // å¤‰æ›´å‰ã®å€¤ã‚’è¨˜éŒ²ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ãªã„æ™‚ã ã‘å–å¾—ï¼‰
            if (!c._oldValues) c._oldValues = {};
            const storageKey = `${key}_${isMax}`;
            if (c._oldValues[storageKey] === undefined) {
                c._oldValues[storageKey] = isMax ? c.data[key].max : (typeof c.data[key] === 'object' ? c.data[key].current : c.data[key]);
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆã“ã“ã¯å³åº§ã«è¡Œã†ï¼‰
            if(isMax) c.data[key].max = parseInt(val); 
            else if(typeof c.data[key] === 'object') c.data[key].current = parseInt(val);
            else c.data[key] = parseInt(val);
            
            saveData();

            // ãƒ­ã‚°å‡ºåŠ›ã®äºˆç´„ï¼ˆ500msä»¥å†…ã«æ¬¡ã®æ“ä½œãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å†äºˆç´„ï¼‰
            clearTimeout(logTimeout);
            logTimeout = setTimeout(() => {
                const oldVal = c._oldValues[storageKey];
                const newVal = parseInt(val);

                if (oldVal != newVal) {
                    addLogEntry('system', '', `[${c.name}] ${label}${isMax?'(æœ€å¤§)':''}: ${oldVal} -> ${newVal}`);
                }
                
                // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ
                delete c._oldValues[storageKey];
            }, 500); // 0.5ç§’é–“æ“ä½œãŒæ­¢ã¾ã£ãŸã‚‰ãƒ­ã‚°ã‚’å‡ºã™
        }

function renderCurrentCharacterSheet() {
    const c = appState.characters[appState.currentCharacterId]; if(!c) return;
    const d = c.data;
    let h = `<input type="text" value="${c.name}" class="w-full font-bold border-b mb-2 focus:outline-none" onchange="appState.characters['${c.id}'].name=this.value; renderCharacterSelector(); saveData();">`;
    h += `<div class="grid grid-cols-2 gap-2 text-[10px]">`;

    const resourceConfigs = [
        {id:'skill', l:'æŠ€é‡ç‚¹', bg:'yellow', type:'single'}, 
        {id:'life', l:'ç”Ÿå‘½ç‚¹', bg:'red', type:'sub-life'}, 
        {id:'subAbility', l:'èƒ½åŠ›', bg:'blue', type:'sub'}, 
        {id:'follower', l:'å¾“è€…', bg:'green', type:'dual'}, 
        {id:'food', l:'é£Ÿæ–™', bg:'orange', type:'single'},
        {id:'clue', l:'æ‰‹ãŒã‹ã‚Š', bg:'indigo', type:'single'},
        {id:'gold', l:'é‡‘è²¨', bg:'amber', type:'single'}
    ];

    resourceConfigs.forEach(res => {
        if(c.deletedResources.includes(res.id)) return;
        h += `<div class="bg-${res.bg}-50 border border-${res.bg}-200 p-1 rounded relative group">
                <button onclick="appState.characters['${c.id}'].deletedResources.push('${res.id}'); renderCurrentCharacterSheet(); saveData();" class="absolute top-0 right-0 text-red-400 hidden group-hover:block px-1">Ã—</button>`;

        // --- ç”Ÿå‘½ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠå¼ï¼‰ ---
        if(res.type === 'sub-life') {
            h += `<select class="font-bold bg-transparent" onchange="const c=appState.characters['${c.id}']; c.data.life.type=this.value; c.data.life.label=this.options[this.selectedIndex].text; renderCurrentCharacterSheet(); saveData();">
                <option value="hp" ${d.life.type==='hp'?'selected':''}>ç”Ÿå‘½ç‚¹</option>
                <option value="num" ${d.life.type==='num'?'selected':''}>äººæ•°</option>
                <option value="app" ${d.life.type==='app'?'selected':''}>å‡ºç¾æ•°</option>
            </select>
            <div class="flex items-center justify-center space-x-1 mt-1">
                <input type="number" value="${d.life.current}" class="resource-input !w-10" onchange="onResChange('life','ç”Ÿå‘½',this.value)">/
                <input type="number" value="${d.life.max}" class="resource-input !w-10" onchange="onResChange('life','ç”Ÿå‘½',this.value,true)">
            </div>`;
        }
        // --- èƒ½åŠ›ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠå¼ï¼‰ ---
        else if(res.type === 'sub') {
            h += `<select class="font-bold bg-transparent" onchange="const c=appState.characters['${c.id}']; c.data.subAbility.type=this.value; c.data.subAbility.label=this.options[this.selectedIndex].text; renderCurrentCharacterSheet(); saveData();">
                <option value="luck" ${d.subAbility.type==='luck'?'selected':''}>å¹¸é‹</option>
                <option value="str" ${d.subAbility.type==='str'?'selected':''}>ç­‹åŠ›</option>
                <option value="mag" ${d.subAbility.type==='mag'?'selected':''}>é­”è¡“</option>
                <option value="dex" ${d.subAbility.type==='dex'?'selected':''}>å™¨ç”¨</option>
            </select>
            <div class="flex items-center justify-center space-x-1 mt-1">
                <input type="number" value="${d.subAbility.current}" class="resource-input !w-10" onchange="onResChange('subAbility','èƒ½åŠ›',this.value)">/
                <input type="number" value="${d.subAbility.max}" class="resource-input !w-10" onchange="onResChange('subAbility','èƒ½åŠ›',this.value,true)">
            </div>`;
        }
        else if(res.type === 'dual') {
            h += `<span class="font-bold text-gray-600">${res.l}</span><div class="flex items-center justify-center space-x-1 mt-1"><input type="number" value="${d[res.id].current}" class="resource-input !w-10" onchange="onResChange('${res.id}','${res.l}',this.value)">/<input type="number" value="${d[res.id].max}" class="resource-input !w-10" onchange="onResChange('${res.id}','${res.l}',this.value,true)"></div>`;
        } 
        else {
            h += `<span class="font-bold text-gray-600">${res.l}</span><div class="mt-1 flex justify-center"><input type="number" value="${d[res.id]}" class="resource-input w-full" onchange="onResChange('${res.id}','${res.l}',this.value)"></div>`;
        }
        h += `</div>`;
    });

    h += `</div><textarea class="w-full mt-2 text-[10px] border h-20 p-1 rounded" placeholder="ãƒ¡ãƒ¢ãƒ»æ‰€æŒå“" onchange="appState.characters['${c.id}'].data.memo=this.value; saveData();">${d.memo || ""}</textarea>
    <div class="flex flex-col gap-1 mt-2"><button onclick="appState.characters['${c.id}'].deletedResources=[]; renderCurrentCharacterSheet(); saveData();" class="text-[9px] text-gray-400">é …ç›®ãƒªã‚»ãƒƒãƒˆ</button><button onclick="deleteChar()" class="text-[9px] text-red-400">ã‚­ãƒ£ãƒ©å‰Šé™¤</button></div>`;
    document.getElementById('current-character-sheet').innerHTML = h;
}

        // --- Dice & Logs ---

        function handleRlhRoll(mode) {
            const c = appState.characters[appState.currentCharacterId];
            if(!c) return;

            let baseValue = 0;
            let label = "";

            if (mode === 'skill') {
                baseValue = c.data.skill || 0;
                label = "æŠ€é‡";
            } else {
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹èƒ½åŠ›å€¤ï¼ˆå¹¸é‹ãƒ»ç­‹åŠ›ãªã©ï¼‰ã®ã€Œç¾åœ¨å€¤ã€ã‚’å–å¾—
                baseValue = c.data.subAbility.current || 0;
                label = c.data.subAbility.label || "èƒ½åŠ›";
            }
            
            // ä¸Šéƒ¨ã®ä¿®æ­£å€¤ãƒœãƒƒã‚¯ã‚¹ã®å€¤
            const modInput = document.getElementById('skillValue'); 
            const modValue = modInput ? parseInt(modInput.value) : 0;
            
            // åˆè¨ˆä¿®æ­£å€¤ (x)
            const sk = baseValue + modValue;
            
            const n = parseInt(document.getElementById('rollCount').value);
            const tg = parseInt(document.getElementById('targetValue').value);
            
            let s=0, f=0, cr=0, fum=0, details=[];
            for(let i=0; i<n; i++){
                const r = Math.floor(Math.random()*6)+1, tot = r+sk;
                let res= (r===6)?"ã€ã‚¯ãƒªã€‘":(r===1)?"ã€ãƒ•ã‚¡ãƒ³ã€‘":(tot>=tg)?"æˆåŠŸ":"å¤±æ•—";
                if(r===6){s++;cr++;}else if(r===1){f++;fum++;}else if(tot>=tg){s++;}else{f++;}
                details.push(`#${i+1}: 1D6(${r})+${sk}=${tot} -> ${res}`);
            }
            
            addLogEntry('dice', `${label}åˆ¤å®š`, 
                `[åˆ¤å®šè€…: ${c.name}]\n` +
                `ä½¿ç”¨æ•°å€¤: ${label}(${baseValue}) + ä¿®æ­£(${modValue}) = è¨ˆ+${sk}\n` +
                `${n}RLH >= ${tg}\n` +
                `${details.join('\n')}\n` +
                `æˆåŠŸ:${s} å¤±æ•—:${f} (C:${cr}/F:${fum})`
            );
        }

        function handleLocalRoll(cmd, label) {
            const c = appState.characters[appState.currentCharacterId];
            // ä¿®æ­£å€¤ï¼ˆquickModValueï¼‰ã‚’å–å¾—
            const mod = parseInt(document.getElementById('quickModValue').value) || 0;
            let res = "";

            if(cmd==='1D3') { 
                const r = Math.floor(Math.random()*3)+1; 
                res = `1D3(${r})+${mod}=${r+mod}`; 
            }
            else if(cmd==='1D6') { 
                const r = Math.floor(Math.random()*6)+1; 
                res = `1D6(${r})+${mod}=${r+mod}`; 
            }
            else if(cmd==='D33') {
                const r1 = Math.floor(Math.random()*3)+1;
                const r2 = Math.floor(Math.random()*3)+1;
                res = `D33[${r1},${r2}](${r1*10+r2})+${mod}=${(r1*10+r2)+mod}`;
            }
            else if(cmd==='D66') { 
                const r1=Math.floor(Math.random()*6)+1, r2=Math.floor(Math.random()*6)+1; 
                res=`D66[${r1},${r2}](${r1*10+r2})+${mod}=${(r1*10+r2)+mod}`; 
            }
            else if(cmd==='Treasure'){
    const r = Math.floor(Math.random()*6)+1;
    const total = r + mod; // ãƒ€ã‚¤ã‚¹ç›®ï¼‹ä¿®æ­£å€¤ã®åˆè¨ˆ
    let detail = "";
    let isCsvData = false;

    // --- 1. CSV(scenarioMaster) ã‹ã‚‰åˆè¨ˆå€¤(total)ã§æ¤œç´¢ ---
    const csvEntry = scenarioMaster.find(s => s.type === 'treasure' && s.id === total.toString());

    if (csvEntry) {
        // ã€CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ãŸå ´åˆã€‘
        detail = csvEntry.text;
        isCsvData = true;
    } else {
        // ã€CSVã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã€‘é»„æ˜ã®é¨å£«æº–æ‹ 
        if (total <= 1) {
                    detail = "é‡‘è²¨1æš";
                } else if (total === 2) {
                    const d = Math.floor(Math.random()*6)+1;
                    detail = `1D6(${d})æšã®é‡‘è²¨`;
                } else if (total === 3) {
                    const d1 = Math.floor(Math.random()*6)+1;
                    const d2 = Math.floor(Math.random()*6)+1;
                    let sum = d1 + d2;
                    let lowLimit = "";
                    if (sum < 5) { sum = 5; lowLimit = "(ä¸‹é™5æšé©ç”¨)"; }
                    detail = `2D6[${d1},${d2}](${d1+d2}) -> ${sum}æšã®é‡‘è²¨ ${lowLimit}`;
                } else if (total === 4) {
                    const a1 = Math.floor(Math.random()*6)+1;
                    const a2 = Math.floor(Math.random()*6)+1;
                    detail = `ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼1å€‹ (ä¾¡å€¤: 1D6[${a1}]Ã—1D6[${a2}] = ${a1*a2}æšã®é‡‘è²¨)`;
                } else if (total === 5) {
                    const d = Math.floor(Math.random()*6)+1;
                    let value = d * 5;
                    let lowLimit = "";
                    if (value < 15) { value = 15; lowLimit = "(ä¸‹é™15æšé©ç”¨)"; }
                    detail = `å®çŸ³ãƒ»å°1å€‹ (ä¾¡å€¤: 1D6(${d})Ã—5 = ${d*5} -> ${value}æšã®é‡‘è²¨ ${lowLimit})`;
                } else if (total === 6) {
                    const d1 = Math.floor(Math.random()*6)+1;
                    const d2 = Math.floor(Math.random()*6)+1;
                    let value = (d1 + d2) * 5;
                    let lowLimit = "";
                    if (value < 30) { value = 30; lowLimit = "(ä¸‹é™30æšé©ç”¨)"; }
                    detail = `å®çŸ³ãƒ»å¤§1å€‹ (ä¾¡å€¤: 2D6[${d1},${d2}](${d1+d2})Ã—5 = ${(d1+d2)*5} -> ${value}æšã®é‡‘è²¨ ${lowLimit})`;
                } else {
                    detail = "â˜…â˜…â˜… é­”æ³•ã®å®ç‰©è¡¨ã‚’ãƒ­ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ â˜…â˜…â˜…";
                }
    }

    // ãƒ­ã‚°ã«ã€Œä¿®æ­£å€¤è¾¼ã¿ã®åˆè¨ˆã€ã¨ã€Œå…ƒã®ãƒ€ã‚¤ã‚¹ç›®ã€ã‚’æ˜è¨˜ã™ã‚‹
    const modText = mod !== 0 ? `(${r}${mod >= 0 ? '+' : ''}${mod})` : "";
    res = `å®ç‰©çµæœï¼š${total}${modText}\nå†…å®¹ï¼š${detail}`;
    
    addLogEntry('dice', label, `[å®Ÿè¡Œè€…: ${c.name}]\n${res}`);
    return;
}

            // Treasureä»¥å¤–ã®ãƒ€ã‚¤ã‚¹ï¼ˆ1D6ãªã©ï¼‰ã®ãƒ­ã‚°å‡ºåŠ›
            addLogEntry('dice', label, `[å®Ÿè¡Œè€…: ${c.name}]\n${res}`);
        }

        function addLogEntry(type, title='', content='') {
            const e = { type, content: type==='dice'?`ã€${title}ã€‘\n${content}`:content, time: new Date().toLocaleTimeString() };
            if(type==='input') { const i=document.getElementById('logInput'); if(!i.value.trim()) return; e.content=i.value; i.value=''; }
            appState.logEntries.push(e); renderLogArea(); saveData();
        }

        function renderLogArea() {
            const a = document.getElementById('logArea');
            a.innerHTML = appState.logEntries.map((e, idx) => {
                if(e.type==='separator') return `<div class="border-t-2 border-purple-200 my-4 relative group"><button onclick="deleteLog(${idx})" class="absolute -top-3 right-0 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] hidden group-hover:block">Ã—</button></div>`;
                return `<div class="p-2 border rounded text-xs relative group ${e.type==='dice'?'bg-indigo-50':e.type==='system'?'bg-gray-100':'bg-white'}">
                    <div class="flex justify-between text-[9px] text-gray-400"><span>${e.time}</span><div class="opacity-0 group-hover:opacity-100"><button onclick="editLog(${idx})">âœ</button> <button onclick="deleteLog(${idx})">Ã—</button></div></div>
                    <div class="whitespace-pre-wrap">${e.content}</div></div>`;
            }).join('');
            a.scrollTop = a.scrollHeight;
        }

        // --- Utils ---
        
        // ã€ã“ã“ã«è¿½åŠ ï¼ã€‘ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
        function toggleHelp(show) {
            const modal = document.getElementById('helpModal');
            if (modal) {
                modal.style.display = show ? 'block' : 'none';
            }
        }
 
        function deleteLog(i){ appState.logEntries.splice(i,1); renderLogArea(); saveData(); }
        function editLog(i){ const n=prompt("ç·¨é›†",appState.logEntries[i].content); if(n!==null){appState.logEntries[i].content=n; renderLogArea(); saveData();}}
        function deleteChar() { if(Object.keys(appState.characters).length > 1 && confirm("å‰Šé™¤ï¼Ÿ")){ delete appState.characters[appState.currentCharacterId]; appState.currentCharacterId = Object.keys(appState.characters)[0]; renderAll(); saveData(); }}
        function switchCharacter(id) { appState.currentCharacterId = id; renderCurrentCharacterSheet(); }
        function renderCharacterSelector() { document.getElementById('charSelector').innerHTML = Object.entries(appState.characters).map(([id,c])=>`<option value="${id}" ${id===appState.currentCharacterId?'selected':''}>${c.name}</option>`).join(''); }
        function renderAll() { 
            document.getElementById('logTitle').value = appState.logTitle; 
            renderD66Grid(); renderD66Table(); renderLogArea(); renderCharacterSelector(); renderCurrentCharacterSheet(); 
        }
        // ãƒ­ã‚°ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ä¿å­˜
        function exportLogText() {
            const title = document.getElementById('logTitle').value || "session_log"; // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
            let t = `SESSION: ${title}\n\n`;
            appState.logEntries.forEach(e => t += `[${e.time}] ${e.content}\n`);
            const b = new Blob([t], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `${title}.txt`; // ãƒ•ã‚¡ã‚¤ãƒ«åã«åæ˜ 
            a.click();
        }
// è¡¨ç¤ºä¸­ã®ã‚­ãƒ£ãƒ©ã®ã¿ä¿å­˜
        function downloadCharacterOnly() {
            const c = appState.characters[appState.currentCharacterId];
            if (!c) return;
            // ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ãƒ•ãƒ©ã‚°(isSingleChar)ã‚’ç«‹ã¦ã‚‹
            const exportData = { ...c, isSingleChar: true };
            const b = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `CHAR_${c.name}.json`;
            a.click();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆå…¨ä½“ä¿å­˜JSONã¨ã‚­ãƒ£ãƒ©å˜ä½“JSONã‚’è‡ªå‹•åˆ¤åˆ¥ï¼‰
        function handleFileUpload(e) { 
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader(); 
            r.onload = (ev) => { 
                try {
                    const data = JSON.parse(ev.target.result);
                    
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å˜ä½“ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
                    if (data.isSingleChar || (data.id && data.data)) {
                        appState.characters[data.id] = data;
                        appState.currentCharacterId = data.id;
                        alert(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${data.name}ã€ã‚’èª­ã¿è¾¼ã¿ãƒ»æ›´æ–°ã—ã¾ã—ãŸã€‚`);
                    } 
                    // å…¨ä½“ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
                    else {
                        appState = { ...appState, ...data };
                        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
                    }
                    
                    renderAll(); 
                    saveData();
                } catch (err) { 
                    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
            }; 
            r.readAsText(f); 
            e.target.value = ''; 
        }
        function resetAllData(){ if(confirm("å…¨æ¶ˆå»ï¼Ÿ")){localStorage.removeItem(STORAGE_KEY); location.reload();}}
        document.getElementById('logInput').addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addLogEntry('input'); }});
        window.onload = loadData;
    </script>
<div id="helpModal" class="modal" onclick="toggleHelp(false)">
    <div class="modal-content custom-scroll" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center border-b pb-2 mb-4">
            <h2 class="text-xl font-bold text-gray-800">RLH Companion ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <button onclick="toggleHelp(false)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="text-sm text-gray-700 space-y-5 leading-relaxed">
            
            <section class="bg-gray-50 p-3 rounded border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨è¨˜</h3>
                <p class="text-[11px]">ä½œè€…ï¼šæˆç”°ç ‚ç”·</p>
                <p class="text-[11px]">ã“ã‚Œã¯FTæ›¸æˆ¿ã«ã‚ˆã‚‹ä¸€äººç”¨TRPGã€Œãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ãƒãƒ¼ãƒ•ã€ã‚’å¿«é©ã«éŠã¶ãŸã‚ã®ã€éå…¬å¼ã€‘ãƒ—ãƒ¬ã‚¤è£œåŠ©ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¬å¼åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã¯ã€BOOTHã«ã¦PDFã‚’ç„¡æ–™é…å¸ƒã—ã¦ã„ã¾ã™ã€‚</p>
                <div class="mt-2 text-[11px] space-y-1">
                    <p>é ’å¸ƒå…ƒ: <a href="https://ftbooks.booth.pm/items/4671946" target="_blank" class="text-blue-600 underline">BOOTH å•†å“ãƒšãƒ¼ã‚¸</a></p>
                    <p>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ­ã‚´: <a href="https://ftbooks.xyz/ftnews/article/RLH-100.jpg" target="_blank" class="text-blue-600 underline">RLH-100.jpg</a></p>
                </div>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">1. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</h3>
                <p>ç”»é¢å³å´ã®ã€Œã‚­ãƒ£ãƒ©ã‚·ãƒ¼ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ“ä½œã—ã¾ã™ã€‚</p>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>è¿½åŠ :</b> ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã§æ–°è¦ä½œæˆã€‚</li>
                    <li><b>æ•°å€¤æ›´æ–°:</b> æŠ€é‡ã€ç”Ÿå‘½ã€é‡‘è²¨ç­‰ã‚’å¤‰æ›´å¯ã€‚é€£æ‰“ã—ã¦ã‚‚ãƒ­ã‚°ã¯æœ€å¾Œã«ã¾ã¨ã‚ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</li>
                    <li><b>èƒ½åŠ›å€¤åˆ‡æ›¿:</b> ã€Œèƒ½åŠ›ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å¹¸é‹ãƒ»ç­‹åŠ›ãƒ»é­”è¡“ãƒ»å™¨ç”¨ã‚’ç®¡ç†ã€‚</li>
                    <li><b>å€‹åˆ¥ä¿å­˜:</b> è¡¨ç¤ºä¸­ã®ã‚­ãƒ£ãƒ©1äººåˆ†ã‚’JSONä¿å­˜ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">2. åˆ¤å®šã¨ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«</h3>
                <p>ç”»é¢ä¸Šéƒ¨ã®ã‚°ãƒ¬ãƒ¼ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>æŠ€é‡åˆ¤å®š:</b> æŠ€é‡ç‚¹ ï¼‹ ä¸Šéƒ¨ä¿®æ­£å€¤ã€‚</li>
                    <li><b>èƒ½åŠ›åˆ¤å®š:</b> é¸æŠä¸­ã®èƒ½åŠ›ç¾åœ¨å€¤ ï¼‹ ä¸Šéƒ¨ä¿®æ­£å€¤ã€‚</li>
                    <li><b>æ±ç”¨ãƒ€ã‚¤ã‚¹:</b> 1D3/1D6/D66/D33ã€‚å·¦ã®ã€Œä¿®æ­£ã€ãƒœãƒƒã‚¯ã‚¹ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚</li>
                    <li><b>å®ç‰©ãƒ­ãƒ¼ãƒ«:</b> 7ä»¥ä¸Šã¯ã€Œé­”æ³•ã®å®ç‰©ã€ãƒœã‚¿ãƒ³ã§æŒ¯ã£ã¦ãã ã•ã„ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">3. D66 GRID ã¨ã‚·ãƒŠãƒªã‚ªé€²è¡Œ</h3>
                <p>ä¸­å¤®ã®GRIDã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>GRIDå…¥åŠ›:</b> ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¹ãŒç‚¹ç¯ï¼ˆ1ã€œ3å›ç›®ã¾ã§è‰²åˆ†ã‘ï¼‰ã€‚</li>
                    <li><b>CSVé€£æº:</b> èª­ã¿è¾¼ã¿æ¸ˆãªã‚‰å‡ºç›®ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒãƒ­ã‚°ã«è‡ªå‹•å‡ºåŠ›ã€‚</li>
                    <li><b>ã‚¤ãƒ™ãƒ³ãƒˆ:</b> ã€Œä¸­é–“ã€ã€Œæœ€çµ‚ã€ã§ç‰¹æ®Šãƒ­ã‚°ã‚’æŒ¿å…¥ã€‚</li>
                </ul>
            </section>

            <section>
                <h3 class="font-bold text-indigo-700 border-l-4 border-indigo-700 pl-2 mb-2">4. ãƒ­ã‚°ã¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</h3>
                <ul class="list-disc ml-5 mt-1 space-y-1">
                    <li><b>ãƒ­ã‚°DL:</b> ã‚»ãƒƒã‚·ãƒ§ãƒ³åã‚’å† ã—ãŸtxtä¿å­˜ã€‚</li>
                    <li><b>å…¨ä½“ä¿å­˜:</b> ã‚­ãƒ£ãƒ©ãƒ»GRIDãƒ»ãƒ­ã‚°ã‚’JSONä¿å­˜ã€‚</li>
                    <li><b>èª­è¾¼:</b> å…¨ä½“ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ©å˜ä½“JSONã‚’å¾©å…ƒã€‚</li>
                </ul>
            </section>

            <section class="text-[11px] text-gray-500 pt-2 border-t">
                <p><b>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</b> 1.0</p>
            </section>

        </div>
        <button onclick="toggleHelp(false)" class="mt-6 w-full bg-gray-800 text-white py-2 rounded-lg font-bold">é–‰ã˜ã‚‹</button>
    </div>
</div>
</body>
</html>
